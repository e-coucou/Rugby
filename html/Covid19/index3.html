<!DOCTYPE html>
<title>COVID-19</title>
<meta name="description" content="Interactive visualisation COVID-19 Data.">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>COVID-19</title>
<style>
@import url(../css/dsp.css);
	#svg {
		display: block;
		margin: auto;
		background:#f5f5f5;
	position : relative;
	}
	#chart {
		display: block;
		margin: auto;
		background:#f5f5f5;
	}
.legendDep rect {
  fill:white;
  stroke:black;
  opacity:0.8;
}.tooltip {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 53px;
}
</style>
<header>
  <div id='h1'>COVID-19</div>
  <aside >Mai, 2020</aside><div id="version"></div>
  <div id='menu'></div>
</header>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.4.3/tabletop.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js" charset="utf-8"></script>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numjs/0.16.0/numjs.js"></script>
    <script defer src="../js/all.js"></script>
	<script type="text/javascript" src="../js/ekseerg-tooltip.js"></script>
	<link rel="stylesheet" href="../css/ekseerg-tooltip.css">
    <div id="chart"></div>
    <div id="tooltipDiv"></div>
<footer>
<aside>(c) e-Coucou | y2K | Novembre, 2020 | data from ARS France & Johns Hopkins University</aside>
    <div id="info"></div>
    <!-- href="https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/">ARS</div></aside>-->
</footer>
    <script type="text/javascript">
// format ...
	let valFormat = (a) => { 
        let r = (a>100) ? Math.round(a) : ( (a>1)? Math.round(a*100.0)/100 : Math.round(a*1000.0)/1000);
        return String(r).replace(/(.)(?=(\d{3})+$)/g,'$1 ');
//        return r;
        }

// Variables Globales
    var timeStart=0,timeStop=0;
    var locale = {
        dateTime: "%A, le %e %B %Y, %X",date: "%d/%m/%Y",time: "%H:%M:%S",periods: ["AM","PM"],days: ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],shortDays: ["dim.","lun.","mar.","mer.","jeu.","ven.","sam."],months: ["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],shortMonths: ["janv.","févr.","mars","avr.","mai","juin","juil.","août","sept.","oct.","nov.","déc."]};

    d3.timeFormatDefaultLocale(locale);

    var first = true;
	let cumul = (array) => array.reduce((a, b) => { return a + b; }); // / array.length;
	let average = (array) => array.reduce((a, b) => { return a + b; }) / array.length;
	
	var sel_date = "01/01/2020", version = "0.20";
	var couleur = ['DarkRed','yellowgreen','RebeccaPurple','skyblue','steelblue','orange','gold','firebrick','darksalmon','darkcyan','darkslateblue','deeppink','darkgoldenrod','navy'];
	let margin = {top: 10, right: 5, bottom: 30, left: 50},
    width = window.innerWidth - margin.right-margin.left,
    height = window.innerHeight - margin.top-margin.bottom -50;
    let orientation=0;
    if (width>height) orientation=1;
    let scale=0, scaleDep = height;
    if (orientation) {scale=width, scaleDep=width} else {scale=height}
	const pathDep = d3.geoPath();
    const projectionDep = d3.geoConicConformal()
        .center([2.454071, 46.279229])
        .scale(2*scaleDep)
        .translate([width/2 , height / 2]);
//        .translate([scaleDep/2 + margin.right, scaleDep / 2]);
    pathDep.projection(projectionDep);

	const svg = d3.select('#chart').append("svg")
    	.attr("id", "svg").attr("position", 2)
    	.attr("width", width+margin.right+margin.left)
    	.attr("height", (height)*1); // nombre de pages

    const departVR_ep = svg.append("g")
        .attr("transform", "translate("+(margin.left*1)+"," + (margin.top) + ")");
//        .attr("transform", "translate("+(margin.left*3+scaleDep*3/5)+"," + (2*height+margin.top) + ")");
//===========================================================
// on ajoute un tooltip
    const eetooltip = new EETooltip({
    	'svgId': 'svg', 
    	'tooltipId': 'tooltipDiv',
    	'headerText': "Incidence covid",
    	'footerText': "Data e-Coucou 2020",
//    	'keepInSVG': true
	});
//===========================================================
//legende de la carte des départements
	console.log(width,scaleDep);
    var legendDep = svg.append('g')
        .attr('transform', function(d) { return 'translate('+(width/2-scaleDep/4)+','+(0 +7*margin.top)+')';})
        .attr('id', 'legendDep');

    var interpolate = d3[`interpolate${'Reds'}`];
    var colors = [];
    const n=14;
//    dark = d3.lab(interpolate(0)).l < 50;
    for (let i = 0; i < n; ++i) {
      colors.push(d3.rgb(interpolate(i / (n - 1))).hex());
    }
	var tantile = d3.scaleQuantile()
//        .domain([ 0,d3.max(dept, function(e) { return e['rea']; })])//.domain([0, 100])
        .domain([0, 13])
        .range(d3.range(13));

    legendDep.selectAll('.colorbar')
        .data(d3.range(13))
        .enter().append('svg:rect')
            .attr('class','legendDep')
            .attr('y', function(d) { return d * 20 + 'px'; })
            .attr('height', '20px')
            .attr('width', '20px')
            .attr('x', '0px')
            .style('fill',function(d,i) { return colors[i];});
//          .attr("class", function(d) { return "q" + d + "-9"; });
    var legendDepScale = d3.scaleLinear()
//        .domain([0, d3.max(dept, function(e) { return e.value; })])
        .domain([0, 13])
        .range([0, 13 * 20]);
    var legendDepAxis = svg.append("g")
        .attr("class","legendDep")
        .attr('transform', function(d) {return 'translate('+( 20+width/2-scaleDep/4)+','+(0 + 7*margin.top)+')';})
        .call(d3.axisRight(legendDepScale).ticks(10));

//=============================================================
// lecture des donnees	
	var url_geoDepart = "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";
	var url_datagouv_all = "https://www.data.gouv.fr/fr/datasets/r/eceb9fb4-3ebc-4da3-828d-f5939712600a";
	var url_departement = "https://docs.google.com/spreadsheets/d/1uw_My3aVfkbFFTtDW64hFg5ujR0FYtDeoahq8h4h3-A/edit?usp=sharing"

    var promises = [];
    promises.push( d3.json('../data/departements.geojson'));
//    promises.push( d3.dsv(";",'../data/sursaud-corona.csv'));
    promises.push( d3.dsv(";",url_datagouv_all));
    promises.push( d3.dsv(";",url_departement));
    var geoDepart = [], carteVR_ep =[], dataGouv=[], dataMoy = [];
    var h_date =[], h_dep =[];
    var iRead=0, rot=0, moy=5;
    let seuil = Math.pow(2,promises.length)-1; // console.log(seuil);

    promises.forEach((p,i) =>{
	    Promise.resolve(p).then(function(val) {
	      dataRead(val,i);
      	});
	});
    function dataRead(data,i) {
          switch(i) {
        	case 0:    geoDepart=data; drawCarte(); break;
        	case 1:    dataGouv=data; break;
        	default: break;
          }
          iRead += (1<<i); // console.log(i, iRead, (iRead>>i)&1, promises.length);
//        infoGT.select('text').text("Chargement ...");
//        infoG.selectAll('circle').attr('fill',d=>{return ((iRead>>d)&1!=0)?'white':'red'});
          if (iRead==seuil) 
          {     start();      }
    }
//===============================================================
// Menu
    var menu = svg.append("g").selectAll("g").data(["<<","Auj.",">>"]).enter()
        .append('g').attr('transform', function(d,i) { return 'translate('+(width-scaleDep/4 +(i-1)*50)+','+(7*margin.top )+')';})
//        .attr("id",(d,i)=>{return "menu_"+i;}).attr("class","menu_select")
        .on('click',click);
    menu.append('circle').style('fill','blue')
        .attr('r',20)
        .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).style('fill','blue');});
    menu.append('text').style('fill','white').style('text-anchor','middle').style("font-size",'10px')
        .attr('dy','0.3em').text(d=>d).raise();

    var menu2 = svg.append('g').selectAll("g").data(["-","Moy.","+"]).enter()
//        .attr('transform', 'translate(80,150)')
        .append("g").attr('transform', function(d,i) { return 'translate('+(width-scaleDep/4+ (i-1)*50)+','+(12*margin.top)+')';})
//        .attr("id",(d,i)=>{return "menu_"+i;}).attr("class","menu_select")
        .on('click',change);
    menu2.append('circle').style('fill','blue')
        .attr('r',20)
        .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).style('fill','blue');});
    menu2.append('text').style('fill','white').style('text-anchor','middle').style("font-size",'10px')
        .attr('dy','0.3em').text(d=>d).raise();


    function click(d,i) {
		//console.log('click',d);
		switch (i) {
		  case 9 :	dataMoyenne(rot,rot+5); updateFill(dataMoy); break;
          case 1 : rot = 0; break;
		  case 0 : rot = (rot + 1) % h_date.length ; break;
		  case 2 : if (rot>0) {rot -= 1} else {rot = h_date.length -1}; break;
		}
			console.log(rot);
			sel_date = h_date[h_date.length-rot-1]; console.log(sel_date); //xxxxx
			carteVR_ep = updtDataCarte(sel_date);
			updateFill(carteVR_ep);
    }

    function change(d,i) {
        switch(i) {
			case 2 : moy += 1; break;
			case 0 : moy -= 1; break;
		}
		dataMoyenne(rot,rot+moy); updateFill(dataMoy);
    }
    async function start() {
		console.log('start'); //console.log(dataGouv);
	    h_dep = [...new Set(dataGouv.map(x=>x.dep))]; //console.log(h_dep);
		h_date = [...new Set(dataGouv.map(x=>x.date_de_passage))]; //console.log(h_date);
		sel_date = h_date[h_date.length-1]; console.log(sel_date); //xxxxx
		carteVR_ep = updtDataCarte(sel_date);
    	//console.log('start', carteVR_ep);
//    	updateDepart(carteVR_ep);
        updateFill(carteVR_ep);
//        const val = await dataMoyenne();
        console.log("fin du start");
//		updateDepart(dataMoy);
    }
// on calcul 

function dataMoyenne(first,nb) { console.log("moyenne ...");
    dataMoy=[]; //console.log(h_dep);
        h_dep.forEach(d=> { 
            let s_cor=0, s_tot=0;
            for(i=first;i<nb;i++){
              date=h_date[h_date.length-i];
              extract = dataGouv.filter(s=> (s.dep==d && s.date_de_passage==date && s.sursaud_cl_age_corona=="0"));
              try { s_cor += Number(extract[0].nbre_pass_corona); } catch {}
			  try { s_tot += Number(extract[0].nbre_pass_tot);} catch {}
            }
            try { val = s_cor/s_tot*100.0;} catch {val=0;}
//          console.log(d,val);
            dataMoy.push({dep:d,'pourcent':val,'cor':s_cor,'tot':s_tot});
        });  //console.log(dataMoy);
        console.log("fin moyenne");
    return 1;
}

function updtDataCarte(date) {
    	let dataVR=[];
        dataGouv.forEach(d=>{ 
            if (d.date_de_passage==date && d.sursaud_cl_age_corona=="0") {
                try {
                    val = Number(d['nbre_pass_corona'])/Number(d['nbre_pass_tot'])*100.0;}
                    catch {console.log('ERREUR');val = 0;}
                dataVR.push({dep:d.dep,'pourcent':val,'cor':Number(d['nbre_pass_corona']),'tot':Number(d['nbre_pass_tot'])});
            }
        });
		return dataVR;
}

function getUnique(value, index, self) { 
        return self.indexOf(value) === index;
}

function updateFill(carte) {
    console.log("mise à jour color");
    departVR_ep.selectAll("path")
            .style("fill",d=>{
                let n=carte.findIndex(k => (k.dep===d.properties.code));//  console.log(n,carteVR_ep[1]);
                if (n!=-1) {
                temp= carte[n].pourcent;
                return colors[tantile(temp)];}
/*
                cl='green';
                if (temp>0.0) cl='yellow';
                if (temp>0.50) cl='#ffba08';
                if (temp>1.00) cl='#f48c06';
                if (temp>1.50) cl='#e85d04';
                if (temp>2.00) cl='#dc2f02';
                if (temp>3.0) cl='#d00000';
                if (temp>5.0) cl='#9d0208';
                if (temp>8.0) cl='#6a040f';
                if (temp>13.0) cl='#370617';
                if (temp>21.0) cl='#03071e';
                if (temp==-1) cl='#03071e';
//                console.log(temp,cl);
                return cl;
                } else return "white";*/
            })
            .on('mouseout',function(d,i){ d3.select(this).style('opacity',0.85) ; eetooltip.hide();eetooltip.removeAllDataBlocks()})//style('fill','#FE6F5E');})
            .on('mouseover',function(d,i){
                let nVR=carte.findIndex(k => (k.dep===d.properties.code));
//                let n=dept.findIndex(k => k.dep===d.properties.code);
                d3.select(this).style('opacity',0.3);
                eetooltip.addDataBlock("Version",version);
                eetooltip.addDataBlock(sel_date,"");
                eetooltip.addDataBlock("", d.properties.nom);
                eetooltip.addDataBlock("code", d.properties.code);
//                eetooltip.addDataBlock("Hospitalisées",valFormat(dept[n].hosp));
//                eetooltip.addDataBlock("en Réanimation",valFormat(dept[n].rea));
//                eetooltip.addDataBlock("Décédées",valFormat(dept[n].dc));
                eetooltip.addDataBlock("Pourcent Covid/Adm.",valFormat(carte[nVR].pourcent)+'%');
                eetooltip.show(); 
        });
}
function drawCarte() {
        departVR_ep.selectAll("path")
            .data(geoDepart.features)
            .enter()
            .append("path")
            .attr('id', function(d) {return "deconf" + d.properties.code;})
            .attr("d", pathDep).style('opacity',0.85).attr("class","depDeconf")
            .style("fill","blue")
            .on('mouseout',function(d,i){ d3.select(this).style('opacity',0.85) })//style('fill','#FE6F5E');})
            .on('mouseover',function(d,i){
                d3.select(this).style('opacity',0.3);  })
            .style('stroke','white').style('stroke-width',0.8);
}
function updateDepart(carte) {
//		departVR_ep.selectAll("path").remove();
        eetooltip.removeAllDataBlocks();
        departVR_ep.selectAll("path")
            .data(geoDepart.features)
            .enter()
            .append("path")
            .attr('id', function(d) {return "deconf" + d.properties.code;})
            .attr("d", pathDep).style('opacity',0.85).attr("class","depDeconf")
            .style("fill",d=>{
                let n=carte.findIndex(k => (k.dep===d.properties.code));//  console.log(n,carteVR_ep[1]);
                if (n!=-1) {
                temp= carte[n].pourcent;
                cl='green';
                if (temp>0.0) cl='yellow';
                if (temp>0.50) cl='#ffba08';
                if (temp>1.00) cl='#f48c06';
                if (temp>1.50) cl='#e85d04';
                if (temp>2.00) cl='#dc2f02';
                if (temp>3.0) cl='#d00000';
                if (temp>5.0) cl='#9d0208';
                if (temp>8.0) cl='#6a040f';
                if (temp>13.0) cl='#370617';
                if (temp>21.0) cl='#03071e';
                if (temp==-1) cl='#03071e';
//                console.log(temp,cl);
                return cl;
            	} else return "black";
            })
            .on('mouseout',function(d,i){ d3.select(this).style('opacity',0.85) ; eetooltip.hide();eetooltip.removeAllDataBlocks()})//style('fill','#FE6F5E');})
            .on('mouseover',function(d,i){
                let nVR=carte.findIndex(k => (k.dep===d.properties.code));
//                let n=dept.findIndex(k => k.dep===d.properties.code);
                d3.select(this).style('opacity',0.3);
                eetooltip.addDataBlock("Version",version);
                eetooltip.addDataBlock(sel_date,"");
                eetooltip.addDataBlock("", d.properties.nom);
                eetooltip.addDataBlock("code", d.properties.code);
//                eetooltip.addDataBlock("Hospitalisées",valFormat(dept[n].hosp));
//                eetooltip.addDataBlock("en Réanimation",valFormat(dept[n].rea));
//                eetooltip.addDataBlock("Décédées",valFormat(dept[n].dc));
                eetooltip.addDataBlock("Pourcent Covid/Adm.",valFormat(carte[nVR].pourcent)+'%');
                eetooltip.show(); 
        })
            .style('stroke','white').style('stroke-width',0.8);
//            dVRTitre1.text('Carte calculée au '+h_dateVR[h_dateVR.length-1]+' (0<1<2<3<5<8<13%)');

};


   </script>

   <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"crossorigin="anonymous"></script>
	<script id="dsq-count-scr" src="//ekseerg.disqus.com/count.js" async=""></script>
</body>
</html>
