<!DOCTYPE html>
<title>COVID-19</title>
<meta name="description" content="Interactive visualisation COVID-19 Data.">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>COVID-19</title>
<style>
	@import url(../css/new.css);
.rky header {
    position: fixed;
    top:0px;
    left:0px;
    width:100%;
    height: 50px;
    z-index: 0;
    background: teal;
  color: #fff;
  font-family: "helvetica neue", sans-serif;
}
.rky header #h1 {
	margin-top: 1vh;
	  margin-left: 2vh;
}
.rky aside {
  font-size: 2.5vh;
  font-family: "helvetica neue", sans-serif;
  font-weight: 150;
  text-anchor: end;
  margin-right: 2vh;
    float: right;
/*    box-shadow: inset 5px 0 5px -5px #29627e;*/
}
.rky h1 {
  font-family: "helvetica neue", sans-serif;
  font-size: 5vh;
  letter-spacing: 0.2vh;
  margin-left: 0px;
  margin-bottom: 0px;
  font-weight: 50;
  text-rendering: optimizeLegibility;
}
	#svg {
		display: block;
		margin: auto;
		background:#f5f5f5;
	position : relative;
	}
	#chart {
		display: block;
		margin: auto;
		background:#f5f5f5;
	}
</style>
<header>
  <div id='h1'>COVID-19</div>
  <aside >Avril, 2020</aside><div id="version"></div>
  <div id='menu'></div>
</header>
<body>
	<script src="https://d3js.org/d3.v5.min.js"></script>
<section class="textoverpic">
  <hr><h1>Bienvenu sur e-Coucou</h1>
  <h1>Pour un tour complet des infos sur le Covid-19</h1>
  <hr><hr>
  <div><aside>Les données proviennent de l'opendata du gouvernement Français</aside>
  	<aside>mise à jour tous les soirs à 19.00 et sont issues des collectes par l'ARS</aside>
  	<aside>Les données internationales proviennent, elles, du site John Hopkings</aside></div>
</section>
<section>
<div id="chart"></div>
</section>
<section class="pop">
  <h1>Population: 325,671</h1>
  <h1>Area: 103,001km<sup>2</sup></h1>
  <h1>= 3 people per square km</h1>
</section>
<section>
  <h1>With abundant geothermal energy, Iceland is also one of the greenest places on earth.</h1>
</section>
<section>
  <h1>Come to Iceland. You’ll be amazed.</h1>
</section>
<section>
	<h2>cecie est une essai</h2>
</section>
<section>
  <h1>Merci pour cette visite et à Bientot sur e-coucou.com.</h1>
</section>
    <script type="text/javascript">
    var locale = {
        dateTime: "%A, le %e %B %Y, %X",date: "%d/%m/%Y",time: "%H:%M:%S",periods: ["AM","PM"],days: ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],shortDays: ["dim.","lun.","mar.","mer.","jeu.","ven.","sam."],months: ["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],shortMonths: ["janv.","févr.","mars","avr.","mai","juin","juil.","août","sept.","oct.","nov.","déc."]};

    d3.timeFormatDefaultLocale(locale);
	let margin = {top: 10, right: 5, bottom: 30, left: 50},
    width = window.innerWidth,
    height = window.innerHeight;
	var url_geoDepart = "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";
	var dataGouv = 'https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7';
    var interpolate = d3[`interpolate${'Blues'}`];
    var colors = [];
    const n=14;
    dark = d3.lab(interpolate(0)).l < 50;
    for (let i = 0; i < n; ++i) {
      colors.push(d3.rgb(interpolate(i / (n - 1))).hex());
    }
    let scale=0;

	const path = d3.geoPath();
	const projection = d3.geoConicConformal()
	    .center([2.454071, 46.279229])
    	.scale(4.0*scale)
    	.translate([scale/2+1*margin.left, scale / 2]);
    path.projection(projection);
	const svg = d3.select('#chart').append("svg")
    	.attr("id", "svg").attr("position", 2)
    	.attr("width", width-margin.right-margin.left)
    	.attr("height", (height-margin.top-margin.bottom));

// ajoute la France des départements
    const depart = svg.append("g")
        .attr("transform", "translate("+(0)+","+(0)+")");

    var promises=[];
    var dept=[];
    var tantile;
    promises.push( d3.json(url_geoDepart));
    promises.push( d3.dsv(";",dataGouv));
    promises.forEach((p,i) =>{
        Promise.resolve(p).then(function(val) {
        dataRead(val,i);
        });
    });

    var dataRegion=[],geojson=[],hopital=[];dataGouv=[];dataGoogle=[],JHDeath=[],JHConfirmed=[],JHRecovered=[],geoDepart=[];
    var iRead=0;
    var h_date=[];

    function dataRead(data,i) {
        switch(i) {
//        case 0:    dataRegion=data; break;
/*        case 2:    geojson=data; break;
        case 3:    dataGoogle=data; break;
*/        case 1:    dataGouv=data; hopital=data;break;
/*        case 5:    JHDeath=data; break;
        case 6:    JHConfirmed=data; break;
        case 7:    JHRecovered=data; break;
*/        case 0:    geoDepart=data; break;
        default:
            break;
        }
        iRead += (1<<i); //console.log(i, iRead, (iRead>>i)&1);
//        infoGT.select('text').text("Chargement ...");
//        infoG.selectAll('circle').attr('fill',d=>{return ((iRead>>d)&1!=0)?'white':'red'});
		let seuil = Math.pow(2,promises.length)-1; console.log(seuil);
        if (iRead==seuil) start();
    }

	function start() {
        h_date = hopital.map(d=>{return d.jour;}).filter(getUnique);
        console.log(hopital,h_date);
//legende de la carte des départements
    var legendDep = svg.append('g')
        .attr('transform', function(d) { return 'translate('+(margin.left)+','+(height +5*margin.top)+')';})
        .attr('id', 'legendDep');
    
    legendDep.selectAll('.colorbar')
        .data(d3.range(13))
        .enter().append('svg:rect')
            .attr('class','legendDep')
            .attr('y', function(d) { return d * 20 + 'px'; })
            .attr('height', '20px')
            .attr('width', '20px')
            .attr('x', '0px')
            .style('fill',function(d,i) { return colors[i];});
//          .attr("class", function(d) { return "q" + d + "-9"; });
    var legendDepScale = d3.scaleLinear()
        .domain([0, d3.max(dept, function(e) { return e.value; })])
//        .domain([0, 750])
        .range([0, 13 * 20]);
    var legendDepAxis = svg.append("g")
        .attr("class","legendDep")
        .attr('transform', function(d) {return 'translate('+( margin.left+20)+','+(height + 5*margin.top)+')';})
        .call(d3.axisRight(legendDepScale).ticks(10));

   	tantile = d3.scaleQuantile()
        .domain([ 0,d3.max(dept, function(e) { return e.value; })])//.domain([0, 100])
        .range(d3.range(13));
	
	getDepartementData();

    updateDepart();
	}
	// ici xxx
	function updateDepart() {
        console.log("Département ",geoDepart,dept);
        depart.selectAll("path")
            .data(geoDepart.features)
            .enter()
            .append("path")
            .attr('id', function(d) {return "dep" + d.properties.code;})
            .attr("d", path).style('opacity',1).attr("class","deps")
//            .style('fill',function(d) { let nid = id(d.properties.code); let val = quantile(data_value[nid]); //console.log(val);
                //console.log(colors[val],getOpositeColor(colors[val])); 
//                return colors[val];})
            .style("fill",d=>{
                let n=dept.findIndex(k => k.dep===d.properties.code);
                return colors[tantile(dept[n].value)];
            })
            .style('stroke','blue').style('stroke-width',1);
	}
    function getDepartementData(date='') {
        var h_dep = hopital.map(d=>{return d.dep;}).filter(getUnique);
        values=[];
        let item='rea'; //selectValue;
        name='France';
        if (date == '') {date = h_date[h_date.length-1];}
        dept=[];
        hopital.forEach(d=>{ //console.log(d,date);
            if (d.jour==date && d.sexe==0) {
                v=Number(d[item]);//console.log(d);
                dept.push({dep:d.dep,value:v});
            }
        });
        console.log('dept rea',dept);
    }
    function getUnique(value, index, self) { 
        return self.indexOf(value) === index;
    }

    </script>
</body></html>