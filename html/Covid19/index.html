<!DOCTYPE html>
<title>COVID-19</title>
<meta name="description" content="Interactive visualisation COVID-19 Data.">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>COVID-19</title>
<style>
@import url(../css/dsp.css);
	#svg {
		display: block;
		margin: auto;
		background:#f5f5f5;
	position : relative;
	}
	#chart {
		display: block;
		margin: auto;
		background:#f5f5f5;
	}
.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.horizontalGrid {
	fill : none;
	shape-rendering : crispEdges;
	stroke : lightgrey;
	stroke-width : 1px;
}

.verticalLine {
	fill : none;
	shape-rendering : crispEdges;
	stroke : lightgrey;
	stroke-width : 1px;
}

.tooltip {
	position: absolute;
	opacity:0.8;
	z-index:1000;
	text-align:left;
	border-radius:4px;
	-moz-border-radius:4px;
	-webkit-border-radius:4px;
	padding:8px;
	color:#fff;
	background-color:#000;
	font: 12px sans-serif;
	max-width: 300px;
	height: 53px;
}
.regionsName, .titleLine {
	color: #333;
	font-family: "HelveticaNeue-Light","Helvetica Neue Light","Helvetica Neue",Helvetica,Arial,sans-serif;
	font-size: 8px;
	padding: 6px 3px 0;
}
select#color {
    position: absolute;
    left: 110px;
    top:35px;
}
select#dataS {
    position: absolute;
    left: 110px;
    top:55px;
}
#cumul {
    position: absolute;
    right: 50px;
    top:30px;
    font-size: 11px;
}
#log {
    position: absolute;
    right: 50px;
    top:45px;
    font-size: 11px;
}
#decalage {
    position: absolute;
    right: 50px;
    top: 60px;
    font-size: 11px;
}
#by100k {
    position: absolute;
    left: 110px;
    top:80px;
    font-size: 11px;
}
.legend rect {
  fill:white;
  stroke:black;
  opacity:0.8;
}
#info {
    color: white;
    opacity: 1.0;
}
</style>
<header>
  <div id='h1'>COVID-19</div>
  <aside >Avril, 2020</aside><div id="version"></div>
  <div id='menu'></div>
</header>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.4.3/tabletop.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
	<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script> 
	<script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js" charset="utf-8"></script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.3.0/d3.min.js"></script>  -->
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js" charset="utf-8"></script>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numjs/0.16.0/numjs.js"></script>
    <script defer src="../js/all.js"></script>
	<script type="text/javascript" src="../js/ekseerg-tooltip.js"></script>
	<link rel="stylesheet" href="../css/ekseerg-tooltip.css">
    <div id="chart"></div>
<select id="color" class="styleSelect">
    <optgroup label="Couleurs by e-Coucou">
        <option value="Spectral">Spectral</option>
        <option value="Purples">Violets</option>
        <option value="Blues">Bleus</option>
        <option value="Oranges">Oranges</option>
        <option value="Greens" selected="">Verts</option>
        <option value="Reds">Rouges</option>
        <option value="Greys">Gris</option>
<!--        <option value="BrBG">BrBG</option>
        <option value="PiYG">PiYG</option>
        <option value="PRGn">PRGn</option>
        <option value="PuOr">PuOr</option>
        <option value="RdBu">RdBu</option>
        <option value="RdGy">RdGy</option>
        <option value="RdYlBu">RdYlBu</option>
        <option value="RdYlGn">RdYlGn</option> -->
        <option value="Turbo">Turbo</option>
        <option value="Plasma">Plasma</option>
        <option value="Magma">Magma</option>
    </optgroup></select>
<select id="dataS" class="styleSelect">
    <optgroup label="Type de données">
        <option value="regions" >by régions (France)</option>
        <option value="hosp" selected="" name="1">Hospitalisations (France)</option>
        <option value="rea" >en Réanimations (France)</option>
        <option value="dc" >Décédées (France)</option>
        <option value="rad" >Guérisons (France)</option>
        <option value="delta" >Delta dc (France)</option>
        <option value="death" >Mortalité Monde</option>
        <option value="recover" >Guérisons Monde</option>
        <option value="cases" >Cas Covid19 Monde</option>
        <option value="simul" >Simulation Epidémie</option>
    </optgroup></select>
	<div id="cumul" >
  		<input id="cumul_i" type="checkbox" value="cumul" class="checkbox">
  		<label for="cumul_i">Global (France/Monde)</label></div>
    <div id="log" >
        <input id="log_i" type="checkbox" value="log" class="checkbox">
        <label for="log_i">Echelle Log.</label></div>
    <div id="decalage" >
        <input id="decalage_i" type="checkbox" value="decalage" class="checkbox">
        <label for="decalage_i">Décalage par Pays</label></div>
    <div id="by100k" >
        <input id="by100k_i" type="checkbox" value="by100k" class="checkbox">
        <label for="by100k_i">Echelle par 100k</label></div>
  <div class="row align-items-center">
    <div class="col-sm-2"><p id="value-simple"></p></div>
    <div class="col-sm"><div id="slider-simple"></div></div>
  </div>
    <div id="tooltipDiv"></div>
<footer>
<aside>(c) e-Coucou | y2K | Mars, 2020 | data from ARS France & Johns Hopkins University</aside><aside>
    <div id="info" href="https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/">ARS</div></aside>
</footer>
    <script type="text/javascript">
// format ...
let valFormat = (a) => { 
        let r = (a>100) ? Math.round(a) : ( (a>1)? Math.round(a*100.0)/100 : Math.round(a*1000.0)/1000);
        return String(r).replace(/(.)(?=(\d{3})+$)/g,'$1 ');
//        return r;
        }

// Variables Globales
    var timeStart=0,timeStop=0;
    var first = true;
	let cumul = (array) => array.reduce((a, b) => { return a + b; }); // / array.length;
	let average = (array) => array.reduce((a, b) => { return a + b; }) / array.length;
	
	var couleur = ['DarkRed','yellowgreen','RebeccaPurple','skyblue','steelblue','orange','gold','firebrick','darksalmon','darkcyan','darkslateblue','deeppink','darkgoldenrod','navy'];
	let margin = {top: 10, right: 5, bottom: 30, left: 50},
    width = window.innerWidth - margin.right-margin.left,
    height = window.innerHeight - margin.top-margin.bottom -50;
    let orientation=0;
    var selMenu=[];
    if (width>height) orientation=1;
//	const colors = d3[`scheme${'Sinebow'}`];	
    var interpolate = d3[`interpolate${'Greens'}`];
    var colors = [];
    const n=14;
    dark = d3.lab(interpolate(0)).l < 50;
    for (let i = 0; i < n; ++i) {
      colors.push(d3.rgb(interpolate(i / (n - 1))).hex());
    }
    let scale=0;
    if (orientation) {scale=height} else {scale=width}
//    let scale=Math.min(width,height);
// console.log(scale,orientation);
// console.log(width,height);

    var dHist = [], dReg = [];
    var selectValue = d3.select("#dataS").property('value');

var public_spreadsheet_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKlM0rqtd30g3tiboIRwjal2KElonjOP2HhoZUanZCFPDd0yeAvaQy18qAkKQxz2_OW6hN36HV9fcE/pubhtml";
var covid_google = "https://spreadsheets.google.com/feeds/cells/1-y1LPejhQw1iJfGMVGS_aHy1g0nbY4SFr3Q1LvazsV8/1/public/full?alt=json";
var allGoogle = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKlM0rqtd30g3tiboIRwjal2KElonjOP2HhoZUanZCFPDd0yeAvaQy18qAkKQxz2_OW6hN36HV9fcE/pub?gid=1181120396&single=true&output=csv";
var dataGouv = 'https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7';
var JH_global_death = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv";
  // draw chart
  var d_Confirmed=[];

	const path = d3.geoPath();
	const projection = d3.geoConicConformal()
	    .center([2.454071, 46.279229])
    	.scale(4.0*scale)
    	.translate([scale/2+1*margin.left, scale / 2]);

    path.projection(projection);

	const svg = d3.select('#chart').append("svg")
    	.attr("id", "svg").attr("position", 2)
    	.attr("width", width+margin.right+margin.left)
    	.attr("height", height+margin.top+margin.bottom);

	const deps = svg.append("g");

//  d3.select('p#value-simple').text(d3.format('.2%')(sliderSimple.value()));

	var fichier = '../data/covid_data.csv';
    var regionsDeps2 = [];
    var promises = [];
    var data_value =[];
//        d3.json("https://d3js.org/us-10m.v1.json"),
//        d3.tsv("unemployment.tsv", function(d) { unemployment.set(d.id, +d.rate); })
    promises.push(d3.json('../data/covid.json')); // function(d,i) {console.log(d); return regionsDeps2.push(d.regions_deps[i]);}),
    promises.push(d3.csv('../data/covid_data.csv'));
    promises.push( d3.json('../data/regions.geojson'));
    promises.push( d3.csv(allGoogle));
    promises.push( d3.dsv(";",dataGouv));
    promises.push( d3.csv(JH_global_death));
//-----------------------------------------------------------------------------
//--
//--
    Promise.all(promises).then(function(values) {
        console.log(values);
        var geojson = values[2],
            hopital = values[4],
            dataRegion = values[0],
            dataGoogle = values[3],
            dataGouv = values[4],
            JHDeath = values[5];

        const parseTime = d3.timeParse("%d/%m/%Y");
        const parseTimeH = d3.timeParse("%Y-%m-%d");

        var h_date = hopital.map(d=>{return d.jour;}).filter(getUnique);

        dataRegion.value.forEach((d,i)=> { return (data_value.push(d*100000/dataRegion.population[i]));});
        selMenu=dataRegion.pays_liste.slice();
        selSimul=dataRegion.simul.slice();
    updateColor();

    d3.select("#version").append("aside").text("| "+dataRegion.proprietes.version+" | "+dataRegion.proprietes.ARS).attr("class","rky aside");
    var quantile = d3.scaleQuantile()
        .domain([ 0,d3.max(data_value, function(e) { return +e; })])//.domain([0, 100])
        .range(d3.range(13));

    var legend = svg.append('g')
        .attr('transform', function(d) { return 'translate('+(margin.left)+','+(5*margin.top)+')';})
        .attr('id', 'legend');
    
    legend.selectAll('.colorbar')
        .data(d3.range(13))
        .enter().append('svg:rect')
            .attr('class','legend')
            .attr('y', function(d) { return d * 20 + 'px'; })
            .attr('height', '20px')
            .attr('width', '20px')
            .attr('x', '0px')
            .style('fill',function(d,i) { return colors[i];});
//          .attr("class", function(d) { return "q" + d + "-9"; });
    var legendScale = d3.scaleLinear()
        .domain([0, d3.max(data_value, function(e) { return +e; })])
        //.domain([0, 100])
        .range([0, 13 * 20]);
    var legendAxis = svg.append("g")
        .attr("class","legend")
        .attr('transform', function(d) {return 'translate('+(margin.left+20)+','+(5*margin.top)+')';})
        .call(d3.axisRight(legendScale).ticks(10));


//-------------------------
// le graphique line ...
//
    let w_g=0,h_g=scale/3*2,dec=1;
    if (orientation) {w_g=width-scale-margin.right-margin.left; dec=2;} else {w_g=scale-margin.left-margin.right; dec=1.4;} //
    const x = d3.scaleTime()
        .range([0, w_g]);
    const y = d3.scaleLinear()
        .range([h_g,0]);
    const yL = d3.scaleSymlog()
        .range([h_g,0]);
    const line = d3.line()
        .x(function(d) { return x(d.date); }) //vep
        .y(function(d) { return (d3.select("#log_i")._groups[0][0].checked) ? yL(d.value) : y(d.value); }) //byEP
        .curve(d3.curveCardinal);
// Le menu select pour les pays
    var menu_select = svg.append("g").selectAll("g").data(dataRegion.pays_liste).enter()
        .append('g')
        .attr('transform', function(d,i) { return 'translate('+(width-w_g+i*25)+','+(4*margin.top)+')';})
        .attr("id",(d,i)=>{return "menu_"+i;}).attr("class","menu_select")
        .on('click',click);
        
    menu_select.append('circle').style('fill',(a)=>{return (selMenu.findIndex(e=> e===a)==-1)?'Gainsboro':colors[colors.length-2];})
        .attr('r',11)
        .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).style('fill',(a)=>{return (selMenu.findIndex(e=> e===a)==-1)?'Gainsboro':colors[colors.length-2];});});
    menu_select.append('text').style('fill','white').style('text-anchor','middle').style("font-size",'10px')
        .attr('dy','0.3em').text(d=>d).raise();

function click(d) {
    let t=selMenu.findIndex(e=>e===d);
    if (t===-1) {
        selMenu.push(d);//console.log(selMenu.findIndex((e)=> e=="FR"));
    } else {
        selMenu.splice(t,1);
    }
    menu_select.selectAll('circle').style('fill',function(m,j) {return (selMenu.findIndex(e=>  m===e)==-1)?"Gainsboro":colors[colors.length-2];});
    update_line();
}        
// Le menu select pour la simulation
    var menu_simul = svg.append("g").selectAll("g").data(dataRegion.simul).enter()
        .append('g')
        .attr('transform', function(d,i) { return 'translate('+(width-w_g+i*25)+','+(6*margin.top)+')';})
        .attr("class","menu_select")
        .on('click',clickSimul);
        
    menu_simul.append('circle').style('fill',(a)=>{return (selSimul.findIndex(e=> e===a)==-1)?'Gainsboro':colors[colors.length-2];})
        .attr('r',11)
        .on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).style('fill',(a)=>{return (selSimul.findIndex(e=> e===a)==-1)?'Gainsboro':colors[colors.length-2];});});
    menu_simul.append('text').style('fill','white').style('text-anchor','middle').style("font-size",'10px')
        .attr('dy','0.3em').text(d=>d).raise();

function clickSimul(d) {
    console.log(d,selSimul);
    let t=selSimul.findIndex(e=>e===d);
    if (t===-1) {
        selSimul.push(d);
    } else {
        selSimul.splice(t,1);
    }
    menu_simul.selectAll('circle').style('fill',function(m,j) {return (selSimul.findIndex(e=>  m===e)==-1)?"Gainsboro":colors[colors.length-2];});
    update_line();
}        

//let h_date_min= parseTimeH(d3.min(h_date))
//let h_date_max= parseTimeH(d3.max(h_date))

  var dsimple = [0,  100];
  var sliderSimple = d3
    .sliderBottom()
    .min(0) //d3.min(dsimple))
    .max(h_date.length-1) //d3.max(dsimple))
    .width(w_g).tickFormat(d3.format('1'))
    .ticks(h_date.length).fill("forestgreen")
    .displayValue(false).step(1)
    .default(h_date.length-1)
    .handle(d3
        .symbol()
        .type(d3.symbolCircle)
        .size(70)()
    )
    .on('onchange', val => {
//        console.log(val,h_date[Math.round(val)]);
        data_value = getDataARS(selectValue,0,h_date[Math.round(val)]);
        updateMap();
//        updateData(h_date[Math.round(val)]);
//        updateData("2020-04-01");
//      d3.select('p#value-simple').text(d3.format('0')(val));
    });
  var gSimple = 
//    d3.select('div#slider-simple')
//    .attr('width', 500)
//    .attr('height', 100)
  svg  .append('g')
    .attr('transform', ()=> {return 'translate('+(margin.left)+','+(height-50)+')';});

  gSimple.call(sliderSimple);


    updateData();
    updateMap();
    update_line();

    //// end -----------


function updateMap() {

//    updateData();
//			console.log(dataRegion.deps.find(d=>{ return d['84']!='undefined';}));
    	deps.selectAll("path")
        	.data(geojson.features)
        	.enter()
        	.append("path")
			.attr('id', function(d) {return "d" + d.properties.code;})
        	.attr("d", path).style('opacity',1).attr("class","regs")
        	.style('fill',function(d) {
        		let nid = id(d.properties.code); let val = quantile(data_value[nid]); //console.log(val);
        		//console.log(colors[val],getOpositeColor(colors[val])); 
        		return colors[val];})
        	.style('stroke','blue').style('stroke-width',1)
        	.on('mouseover', function(d) { 
        		let nid = id(d.properties.code), lid="#l"+nid,rid="#r_"+d.properties.code; //console.log(lid,rid);
    			eetooltip.addDataBlock("", d.properties.nom);
    			eetooltip.addDataBlock("code", d.properties.code);
    			eetooltip.addDataBlock(selectValue,
    				(j) => { return valFormat(data_value[nid]); });
    			eetooltip.addDataBlock("cas/100000",
    				(j) => { return valFormat(dataRegion.value[nid]*100000.0/dataRegion.population[nid]); });
                eetooltip.addDataBlock("population",valFormat(dataRegion.population[nid]));
                eetooltip.addDataBlock("valeur",valFormat(data_value[nid]));
//    			eetooltip.addDataBlock("height", this.getBBox().height);
//    			eetooltip.addDataBlock("x", this.getBBox().x);
    			eetooltip.show();
//    			d3.select((d)=>{ console.log(nid); return "#"+nid;}).style("stroke-width",4);
    			d3.select(lid).style("stroke-width",4);
    			let cRGB = convertToHexColor(couleur[nid]);
//    			let cHex=convertRGBDecimalToHex(cRGB);console.log(cHex,cRGB);
   				let c=getOpositeColor(cRGB); //console.log(cHex,nid,couleur[nid],c);
    			d3.select(rid).style("fill",c);
        		return d3.select(this).style('stroke-width',2)
        			.style("fill",(d)=>{c=id(d.properties.code); return couleur[c];});})
        	.on('mouseout', function(d) { 
        		let nid = id(d.properties.code), lid="#l"+nid,rid="#r_"+d.properties.code; //console.log(lid,rid);
    			eetooltip.hide();
    			eetooltip.removeAllDataBlocks();
    			d3.select(lid).style("stroke-width",1);
    			d3.select(rid).style("fill","#000");
				return d3.select(this).style('stroke-width',1).style("fill",(d)=> {
        		let nid = id(d.properties.code); let val = quantile(data_value[nid]); //console.log(val);
        		return colors[val];})});

        deps.selectAll("text")
			.data(geojson.features)
			.enter()
			.append("text")
			.attr("class","regionsName")
			.attr("id",(d,i)=>{return "r_"+d.properties.code})
			.text(function(d){ return d.properties.nom;})
			.attr("x", function(d){return path.centroid(d)[0];})
			.attr("y", function(d){return  path.centroid(d)[1];})
			.attr("text-anchor","middle");

         deps.selectAll("path").transition().duration(2000)
            .style('fill',function(d) {
                let nid = id(d.properties.code); let val = quantile(data_value[nid]); //console.log(val);
                //console.log(colors[val],getOpositeColor(colors[val])); 
                return colors[val];})

//    legend.selectAll("rect").style('fill',function(d,i) { return colors[i];});

}

function update_line() {
	var dMult = [];
    let index=dHist.findIndex(d=>{return d.item==selectValue;}); //console.log('item',index,selectValue);
    let indexReg=dReg.findIndex(d=>{return d.item==selectValue;}); //console.log('item',index,selectValue);
    // on decale les courbes enfct des Pays
    let cb = d3.select("#decalage_i"); //console.log('ici : ',cb,cb._groups[0][0].checked);
    if (cb._groups[0][0].checked) {
        dReg[indexReg].data.forEach((d)=>{
            name = d.name;
            let val = [];
            d.values.forEach((a,i,t)=>{
                newD = new Date();
                newD.setTime(a.date.getTime() - 86400000*dataRegion.pays_decalage[d.n]);// console.log(newD,dataRegion.pays_decalage[d.n])
                val.push({date:newD,value:a.value});
            }); //console.log(d.n,dataRegion.pays_decalage[d.n]);
            val=val.slice(dataRegion.pays_decalage[d.n]);
            if (selMenu.findIndex(e=>e===d.n)!=-1)
                dMult.push({name,values:val});
            if (selSimul.findIndex(e=>e===d.n)!=-1){
                console.log('ici',selSimul);
                dMult.push({name,values:val});}
        }) ; //    console.log('dMult-dec',dMult);
    } else {
        dReg[indexReg].data.forEach(d=>{
            if (d.n != undefined) {
                if (selMenu.findIndex(e=>e===d.n)!=-1)
                dMult.push({name:d.name,values:d.values});
                if (selSimul.findIndex(e=>e===d.n)!=-1)
                dMult.push({name:d.name,values:d.values});
            } else { if (dMult.length <= 0)
                dMult=dReg[indexReg].data.slice(); //console.log('ici : ',dMult);
            }
        }) ; //console.log('dMult -ori',dMult);
    }
    let cb2 = d3.select("#cumul_i"); //console.log('ici : ',cb,cb._groups[0][0].checked);
    if (cb2._groups[0][0].checked) dMult.push({'name':dHist[index].name,'values':dHist[index].values});
    //
//    x.domain(d3.extent(dHist[index].values, function(d) { return d.date; }));
    let maj =  d3.max(dMult, function(c) {
        return d3.max(c.values, function(v) {
        return v.date; });}).toLocaleDateString('fr-FR'); 

    x.domain([
        d3.min(dMult, function(c) {
        return d3.min(c.values, function(v) {
        return v.date; });}),
        d3.max(dMult, function(c) {
        return d3.max(c.values, function(v) {
        return v.date; });})]);
	y.domain([0, d3.max(dMult, function(c) {
      	return d3.max(c.values, function(v) {
        return v.value; });})]);
	yL.domain([0, d3.max(dMult, function(c) {
      	return d3.max(c.values, function(v) {
        return v.value; });})]);
	// on efface ...
	d3.selectAll(".g_line").remove();
	const g_line = svg
	    .append("g")
	    .attr("class","g_line")
    	.attr("transform", "translate(" + (width-w_g) + "," + (height/dec-h_g/2+margin.top) + ")");
    // Ajout de l'axe X
    g_line.append("g")
        .attr("transform", "translate(0," + h_g + ")")
        .call(d3.axisBottom(x).ticks(dHist[index].values.length-1).tickFormat(d3.timeFormat("%a %d/%m")))
        .selectAll("text")	
        	.style("text-anchor", "end")
        	.attr("dx", "-.8em")
        	.attr("dy", ".15em")
        	.attr("transform", "rotate(-65)");
    // Ajout de l'axe Y et du texte associé pour la légende
    g_line.append("g")
        .call((d3.select("#log_i")._groups[0][0].checked) ? d3.axisLeft(yL) : d3.axisLeft(y))
        .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .style("text-anchor", "end")
            .text("Malades");
    // Ajout de la grille horizontale (pour l'axe Y donc). Pour chaque tiret (ticks), on ajoute une ligne qui va 
    // de la gauche à la droite du graphique et qui se situe à la bonne hauteur.
    g_line.selectAll("y axis").data(y.ticks(10)).enter()
        .append("line")
        .attr("class", "horizontalGrid")
        .attr("x1", 0)
        .attr("x2", w_g)
        .attr("y1", function(d){ return (d3.select("#log_i")._groups[0][0].checked) ? yL(d) : y(d);})
        .attr("y2", function(d){ return (d3.select("#log_i")._groups[0][0].checked) ? yL(d) : y(d);});
    // on trace toutes les courbes
    var g_lines = g_line.selectAll(".currency")
        .data(dMult).enter().append("g")
        .attr("class", "currency");

    g_lines.append("path")
        .attr("class", "line")
        .attr("id",(d,i)=>{return "l"+i;}).transition().duration(2000)
        .attr("d", (d)=>{return line(d.values);})
        .style("stroke", function(d,i) { return couleur[i];});

    var legendM = g_lines.append("g")
        .attr("class","legend")
        .attr("transform",(d,i)=>{ return "translate(50,"+(30+i*16)+")";});
        legendM.append('circle')
            .attr('r',3).attr('cx',3).attr('cy',2).style('fill',(d,i)=>{return couleur[i];});
        legendM.append("text").style("font-size","12px").attr('x',10).attr('y',6).style('text-anchor','start')
        .text((d)=>{return d.name;})
    // curseur
	var mouseG = g_line.append("g")
  		.attr("class", "mouse-over-effects");
	mouseG.append("path")
		.attr("class", "mouse-line")
		.style("stroke", "grey")
		.style("stroke-width", "1px").style("stroke-dasharray",2)
		.style("opacity", "0");
	var mousePerLine = mouseG.selectAll('.mouse-per-line')
		.data(dMult).enter()
 		.append("g").attr("class", "mouse-per-line");
    // reperage du point d'intersection curseur/courbe
	mousePerLine.append("circle")
		.attr("r", 3)
		.style("stroke", function (d,i) { return couleur[i];})
		.style("fill", "none").style("stroke-width", "2px").style("opacity", "0");
	mousePerLine.append("text")
    	.attr("class", "hover-text")
    	.attr("dy", "-1em")
    	.attr("transform", "translate(10,3)");
    //on ajoute un titre au graphique
	g_line.append('text')
		.attr('x', (w_g)).attr('y', 0 - (margin.top / 3))
		.attr('text-anchor', 'end')
		.attr("class","titleLine")
		.style('font-size', '8px') 
        .text((d) => {return (selectValue==='regions')?"Maj "+dataRegion.proprietes.data_version:"Maj "+maj; });
    //        .text((d) => {return (selectValue=="regions")?('Mise à jour ARS au '+dataRegion.proprietes.data_version):('Mise à jour Gouv au '+dataRegion.proprietes.ARS) ;});
    // Append a rect to catch mouse movements on canvas
	mouseG.append('svg:rect') 
		.attr('width', w_g) .attr('height', h_g)
		.attr('fill', 'none')
		.attr('pointer-events', 'all')
		.on('mouseout', function () { // on mouse out hide line, circles and text
  			d3.select(".mouse-line").style("opacity", "0");
			d3.selectAll(".mouse-per-line circle").style("opacity", "0");
			d3.selectAll(".mouse-per-line text").style("opacity", "0");
			})
		.on('mouseover', function () { // on mouse in show line, circles and text
			d3.select(".mouse-line").style("opacity", "1");
			d3.selectAll(".mouse-per-line circle").style("opacity", "1");
			d3.selectAll(".mouse-per-line text").style("opacity", "1");
  			})
		.on('mousemove', function () { // mouse moving over canvas
			var mouse = d3.mouse(this);
				d3.selectAll(".mouse-per-line")
      				.attr("transform", function (d, i) {
						var xDate = x.invert(mouse[0]),
							bisect = d3.bisector(function (d) { return d.date; }).left;
							idx = bisect(d.values, xDate);
                            try {
							d3.select(this).select('text')
								.text(valFormat(y.invert(y(d.values[idx].value)).toFixed(0))+" "+d.name);
							d3.select(".mouse-line")
								.attr("d", function () {
									var data = "M" + x(d.values[idx].date) + "," + h_g;
										data += " " + x(d.values[idx].date) + "," + 0;
									return data; });
					return "translate(" + x(d.values[idx].date) + "," + ((d3.select("#log_i")._groups[0][0].checked)?yL(d.values[idx].value):y(d.values[idx].value)) + ")";
                            } catch {}
				});
  			});
    
}
    //-----
    function id(code) {
		let find = dataRegion.regions.find(f=>{ return f[code]!=undefined;});
		return find[code].id;
    }

    function updateData(selDate = dataRegion.proprietes.ARS) {
        data_value =[];
        var cases = 0;
        selectValue = d3.select("#dataS").property('value');
        data_value = getDataARS(selectValue,0,selDate);
        switch(selectValue) {
            case 'regions':
                data_value = dataRegion.value;
            case 'dc': case 'hosp': case 'rea': case 'rad': case 'delta':
                menu_select.selectAll('circle').style("visibility","hidden");
                menu_simul.selectAll('circle').style("visibility","hidden");
                d3.select("#decalage").style("visibility","hidden");
                d3.select("#decalage").selectAll("input[type=checkbox]").property("checked",false);
                //d3.selectAll("input[type=checkbox]").property("checked", false);
                break;
            case 'simul':
                data_value = getDataARS('dc',0,selDate);
                menu_select.selectAll('circle').style("visibility","hidden");
                menu_simul.selectAll('circle').style("visibility","visible");
                d3.select("#decalage").style("visibility","hidden");
                d3.select("#decalage").selectAll("input[type=checkbox]").property("checked",false);
                break;
            default :
                data_value = getDataARS('dc',0,selDate);
                menu_select.selectAll('circle').style("visibility","visible");
                menu_simul.selectAll('circle').style("visibility","hidden");
                d3.select("#decalage").style("visibility","visible");
                cases=1;
                break;
        }
//        menu_select.selectAll('circle').style('fill',function(m,j) {return (selMenu.findIndex(e=> e===m)!=-1)?"black":colors[colors.length-2];});

        if ((d3.select("#by100k_i")._groups[0][0].checked)) {
            data_value.forEach((d,i,t)=> { return (t[i] = (d*100000/dataRegion.population[i]));});}

        quantile.domain([ 0,d3.max(data_value, function(e) { return +e; })]);
        legendScale.domain([0, d3.max(data_value, function(e) { return +e; })])
        legendAxis.call(d3.axisRight(legendScale).ticks(10));


        d3.selectAll(".regs").transition().duration(3000)
            .style('fill',function(d) {
                let nid = id(d.properties.code); let val = quantile(data_value[nid]); //console.log(val);
                return cases===0?colors[val]:"Gainsboro";});
        // name/values[date/value]
        multi_data = [];
        dataRegion.regions_deps.forEach((r,j)=> {
          values = []; //console.log(j,dataRegion.regions_nom);
          name = dataRegion.regions_nom[j];
          h_date.forEach((d)=> { 
            date= parseTime(d);
            value=getDataRegion(selectValue,j,d,0);
            values.push({date,value});
          });
          multi_data.push({name,values});
        });
       
        dHist = [], dReg = [];
        dataRegion.proprietes.cases.forEach( item=> {
            values=[];
            name='France';
            h_date.forEach(function(h) {
              date = parseTimeH(h);
              let value = hopital.reduce((a,d)=>{ let v=0;
                if (d.jour == h && d.sexe == 0) {
                    v= Number(d[item]);// console.log(a,v);
                }
                return (a+v); },0); //console.log(cum);        value = cumul(d.series);
              values.push({date,value}); // sauvegarde sous forme de hashmap de nos données.
            });
            dHist.push({item,name,values});
            data=[];
            dataRegion.regions_deps.forEach((r,i)=>{
                name=dataRegion.regions_nom[i];
                values=[];
                h_date.forEach(function(h) {
                    value=0;
                    r.forEach( (dep) => {
                        date = parseTimeH(h); //console.log(h);
                        let cum = hopital.reduce((a,d)=>{ let v=0;
                          if (d.dep==dep && d.jour == h && d.sexe == 0) {
                              v= Number(d[item]);}
                          return (a+v); },0); //console.log(cum);        value = cumul(d.series);
                        value += cum;
                    });
                    values.push({date,value}); // sauvegarde sous forme de hashmap de nos données.
                });
                data.push({name,values});
            });
            dReg.push({item,data});
        });
        values=[];
        dataRegion.historique.forEach(function(d) {
            date = parseTime(d.date);
            value = cumul(d.series);
            values.push({date,value}); // sauvegarde sous forme de hashmap de nos données.
        }); 
        item='regions';
        dHist.push({item,values}); //console.log('dHist new',dHist);
//        console.log('multi_data',multi_data);
//        console.log('dHist',dHist);
//        console.log('dReg',dReg);
        index=dHist.findIndex(d=>{return d.item==selectValue;}); //console.log('item',index,selectValue);
        data=[];
        dataRegion.regions.forEach((r,i)=>{
            name=i;
            let values=[];
            dataRegion.historique.forEach((h)=>
                {   
                    date=parseTime(h.date);
                    value=h.series[i];
                    values.push({date,value})
                })
            data.push({name,values});
        });
        dReg.push({item,data});
// dreg : item/data[names/values[date/value]]
    // delta mart
        old=0;values=[];
        dHist[2].values.forEach((d)=>{
            date=d.date;
            value=d.value-old;
            values.push({date,value});
            old=d.value;
        });
        item='delta';
        name='delta dc';
        dHist.push({item,name,values});
        data=[]; data.push({name,values});
        dReg.push({item,data});
        if (first) getData();
        simul();
//        console.log(data_value);

    } //fin de update data
//------------------------
   function getData() {
// get data from google
// dreg : item/data[names/values[date/value]]
        item = ["death","recover","cases"];
        item.forEach((id)=>{ getGoogleData(id);});
        console.log('dHist/dReg',dHist,dReg);
        first = true; // parce que ca marche pas !!
    }
    function getGoogleData(item) {
        nom="All_"+item;
        name="Monde";
        var values = dataGoogle.map((d)=>{ date=parseTime(d.date); value=isNaN(d[nom])?0:Number(d[nom]); return ({date,value});});
        dHist.push({item,name,values}); //console.log("googl all",dHist);
        var data = [];
            dataRegion.pays_liste.forEach((n,i)=>{
            nom = n+"_"+item;
            name = dataRegion.pays[n]; //console.log(name);
            values = dataGoogle.map((d)=>{ date=parseTime(d.date); value=isNaN(d[nom])?0:Number(d[nom]); return ({date,value});});
            data.push({n,name,values});
        });
        dReg.push({item,data});
    }

    function getDataARS(item,sexe,date) {
        let cumR = 0, data =[];
        dataRegion.regions_deps.forEach((l,j)=> 
            {   data.push(getDataRegion(item,j,date,sexe));
            }
    );

        return data;
    };
    function getDataRegion(item,region,date,sexe) {
          let cumR=0;
          dataRegion.regions_deps[region].forEach((r,i)=>{

            let cum = hopital.reduce((a,d)=>{ let v=0;
            if (d.dep == r && d.jour == date && d.sexe == sexe) {
                v= Number(d[item]); //console.log(r,a,v);
            }
            return (a+v); },0); //console.log(cum);
            cumR+= cum;
          });
          return cumR;
        }
    function getUnique(value, index, self) { 
        return self.indexOf(value) === index;
    }

    // customs couleurs des pastilles   thanks to Cynthia Brewer@
    d3.select("#dataS").on("change", function() {
        selectValue = d3.select("#dataS").property('value');
        //console.log(selectValue);
        //console.log(getDataARS(selectValue,0,dataRegion.proprietes.ARS));
        updateData();
        update_line();
    });

    d3.select("#color").on("change", function() {
        updateData();
    	let interpolate = d3[`interpolate${this.value}`];
    	colors = [];
    	const n=13;
    	dark = d3.lab(interpolate(0)).l < 50;
    	for (let i = 0; i < n; ++i) {
      	colors.push(d3.rgb(interpolate(i / (n - 1))).hex());
    	};

		d3.selectAll(".regs").transition().duration(3000)
        	.style('fill',function(d) {
        		let nid = id(d.properties.code); let val = quantile(data_value[nid]); //console.log(val);
        		return colors[val];});

        d3.selectAll(".legend").transition().duration(2000)
        	.style('fill',function(d,i) { return colors[i];});
        menu_select.selectAll('circle').style('fill',function(m,j) {return (selMenu.findIndex(e=> e===m)!=-1)?"black":colors[colors.length-2];});
        menu_simul.selectAll('circle').style('fill',function(m,j) {return (selSimul.findIndex(e=> e===m)!=-1)?"black":colors[colors.length-2];});

        updateColor();
        click();
    });
    // gestion des cases a cocher ...
    d3.select("#cumul").on("change", update_line);
    d3.select("#log").on("change", update_line);
    d3.select("#decalage").on("change", update_line);
    d3.select("#by100k").on("change",(d)=> { updateData(); updateMap(); });

    // on ajoute un tooltip
    const eetooltip = new EETooltip({
    	'svgId': 'svg', 
    	'tooltipId': 'tooltipDiv',
    	'headerText': "Information",
    	'footerText': "Data e-Coucou 2020",
    	'keepInSVG': true
	})

	function getOpositeColor(rgb) { // Like this : rgb(0, 0, 0);
	//	console.log(rgb);
    var regex = /rgb *\( *([0-9]{1,3}) *, *([0-9]{1,3}) *, *([0-9]{1,3}) *\)/;
    var values = regex.exec(rgb);
    if(values.length != 4)
    {
        return rgb; // fall back to what was given.              
    }
    var r = Math.round(parseFloat(values[1]));
    var g = Math.round(parseFloat(values[2]));
    var b = Math.round(parseFloat(values[3]));
    //If is this operation be <= 128 return white, others else return black
//        	OpositeColor = ((0.3 * (color['r'])) + (0.59 * (color['g'])) + (0.11 * (color['b'])) <= 128) ? '#FFF' : '#000';
        	OpositeColor = ((0.3 * (r)) + (0.59 * (g)) + (0.11 * (b)) <= 128) ? '#FFF' : '#000';
        	return OpositeColor;
 //   	}
//    	return -1;
	}
function convertToHexColor(englishColor) {

    // create a temporary div. 
    var div = $('<div></div>').appendTo("body").css('background-color', englishColor);
    var computedStyle = window.getComputedStyle(div[0]);

    // get computed color.
    var computedColor = computedStyle.backgroundColor;

    // cleanup temporary div.
    div.remove();

    // done.
    return computedColor;

    // The above returns "rgb(R, G, B)" on IE9/Chrome20/Firefox13.
}
function convertRGBDecimalToHex(rgb)
{
    var regex = /rgb *\( *([0-9]{1,3}) *, *([0-9]{1,3}) *, *([0-9]{1,3}) *\)/;
    var values = regex.exec(rgb);
    if(values.length != 4)
    {
        return rgb; // fall back to what was given.              
    }
    var r = Math.round(parseFloat(values[1]));
    var g = Math.round(parseFloat(values[2]));
    var b = Math.round(parseFloat(values[3]));
    return "#" 
        + (r + 0x10000).toString(16).substring(3).toUpperCase() 
        + (g + 0x10000).toString(16).substring(3).toUpperCase()
        + (b + 0x10000).toString(16).substring(3).toUpperCase();
}
    function updateColor() {
        // body...
        d3.select("header").transition().duration(2000).style("background-color",colors[colors.length-2]);
        d3.select("footer").transition().duration(2000).style("background-color",colors[colors.length-2]);
    }

    function simul() {
//"modele":{ "population":70000000,"taux_infection":0.04,"mortalité":0.045,"asymptomatique":0.5,"contacts_j":5,"delai_guerison":18,"delai_mort":5,"risque_re":0.0001,"sur_risque_asymp":2}
        var infectes = [], malades = [], morts=[], gueris = [], sains =[], assymp=[];
        var ti = dataRegion.modele.taux_infection, tm=dataRegion.modele.mortalité, ra = dataRegion.modele.asymptomatique,
            c=dataRegion.modele.contacts_j, dg=dataRegion.modele.delai_guerison, dm=dataRegion.modele.delai_mort,
            rr=dataRegion.modele.risque_re, sa = dataRegion.modele.sur_risque_asymp, ddm = dataRegion.modele.decl_maladie;
//console.log(c,sa,rr,ti);
        infectes.push(1000);malades.push(0);morts.push(0);gueris.push(0),sains.push(dataRegion.modele.population),assymp.push(0);
        var date=[];
        date.push(new Date("03/01/2020"));

        for (let i=0; i<100;i++){
            dd = new Date(); dd.setTime(date[i].getTime() + 86400000);//console.log(dd);
            date.push( dd) ;
            delta_D = (i>=(dm)?malades[i-dm]:0)*tm;
            delta_G_A = (i>dg?(assymp[i-dg]-assymp[i-dg-1]):0);
            delta_G_M = (i>dg?(malades[i-dg]-malades[i-dg-1]):0)*(1-tm);
            delta_A = (i>=ddm?infectes[i-ddm]:0)*(1-ra);
            gueris.push(gueris[i]+ delta_G_A +delta_G_M);
            assymp.push(assymp[i] + delta_A - delta_G_A );
            morts.push(morts[i]+ delta_D);
            malades.push(malades[i]+(i>=ddm?infectes[i-ddm]:0)*ra - (i>=dg?malades[i-dg]:0)*(1-tm)- morts[i]);
            infectes.push(Math.max((infectes[i]+assymp[i]*sa+malades[i]*rr+gueris[i]*rr)*c*ti*sains[i]/sains[0] + infectes[i]*0
                + gueris[i]+malades[i]+assymp[i]
                - gueris[i+1] - malades[i+1]-assymp[i+1] ,0));
            sains.push(sains[i]-gueris[i+1]-assymp[i+1]-morts[i+1]-malades[i+1]-infectes[i+1]);
        }
//        date.forEach((d,i,t)=>{t[i]= parseTime(d);});
  //      console.log(gueris,assymp,morts,malades,infectes,date);
        data=[];
        values=[];
        date.forEach(d=>{values.push({date:d,value:0});});
        dHist.push({item:'simul',name:'Global',values});
        values=[];
        morts.forEach((d,i)=>{ values.push({date:date[i],value:d});});
        data.push({name:'mortalité',n:'DC',values});
        values=[];
        malades.forEach((d,i)=>{ values.push({date:date[i],value:d});});
        data.push({name:'malades',n:'MA',values});
        dReg.push({item:'simul',data});
        values=[];
        gueris.forEach((d,i)=>{ values.push({date:date[i],value:d});});
        data.push({name:'gueris',n:'GU',values});
        values=[];
        infectes.forEach((d,i)=>{ values.push({date:date[i],value:d});});
        data.push({name:'infectes',n:'IN',values});
        values=[];
        assymp.forEach((d,i)=>{ values.push({date:date[i],value:d});});
        data.push({name:'assymptotiques',n:'AS',values});
    }

  });
//});
  
   </script>

   <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"crossorigin="anonymous"></script>
	<script id="dsq-count-scr" src="//ekseerg.disqus.com/count.js" async=""></script>
</body>
</html>
