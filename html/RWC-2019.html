<!DOCTYPE html>
<title>RWC</title>
<meta name="description" content="Suivi de match Rugby World Cup 2019.">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>RWC 2019 - JAPON</title>
<style>
@import url(../css/dsp.css);

#chart {
	position : relative;
}
#intervalle {
    position: absolute;
    top: 25px;
    right: 30px;
}
#infoLive {
    position: absolute;
    top: 25px;
    font: 10px sans-serif;
    left: 20px;
    font-family: "helvetica neue", sans-serif;
    color: #191970;
}
text {
  font: 10px sans-serif;
}
.label {
    fill: #777;
}
.rky header {
    background: #1e3F5E;
}
</style>
<body>
<header>
  <div id='h1'>Rugby World Cup</div>
  <aside >Septembre, 2019<br><br>| v 4.30</aside>
  <div id='menu'></div>
</header>
<footer>
    <aside>(c) e-Coucou | y2kJ | Live Data</aside>
    <div id="info"></div>
</footer>
	<script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js" charset="utf-8"></script>
	<script src="../js/menu.js" charset="utf-8"></script>
	<script defer src="../js/all.js"></script>
    <div id="chart"></div>
    <div id="infoLive">Live info ...</div>
    <div id='intervalle'></div>
  <script type="text/javascript">
	var rwc_index = [[ "1","2","3","4","5","952","1023","1238","1558"],["145","344","854","883","913","927","965","1005","1054","1077","1164","1184","1243","1244","1622","1623","1782","1783"],["1183","1236","1296","1557","364","714","855","886","926","940","970","995","1056","1135","1697","1764","1807"],["1577"],["925","957","971","1006","1072","1130","1166","1235","1273","1569","1653","1769"]]; // rwc , six nation , 4 nations , xx , wrc pacific
    var idComp=0, nbComp=rwc_index[idComp].length, iComp=nbComp-1;
	var idLive=0, clock='', selMenu=0;
    var url = '';
	// Chart dimensions.
	var margin = {top: 20, right: 20, bottom: 30, left: 50},
		width = window.innerWidth; // - margin.right-margin.left,
		height = 1300 - margin.top - margin.bottom;
	// Create the SVG container and set the origin.
	var svg = d3.select("#chart").style('top','25px')
		.append("svg")
		.attr('class','svg-contenair')
	//	.attr("preserveAspectRatio", "xMinYMin meet")
		.attr("viewBox", "0 0 "+(width - margin.left - margin.right)+" "+(height + margin.top + margin.bottom))
        .attr("padding-bottom", 0)
		.attr("position", 0)
		.classed("svg-content", true);
	var dispatch = d3.dispatch('load','match','live','dashboard','update');
    dispatch.on('load',affListe);
    dispatch.on('match',affInfo);
    dispatch.on('live',affLive);
	
	var listeMatchs=[],dataInfo=[];
    var t = setInterval(cycle,60000);
    clearInterval(t);
	menu(selMenu);changeComp();
    updateComp(1);

//--------------
// cycle
function cycle() {
//    updateComp(0);
			var urlMatch = 'http://cmsapi.pulselive.com/rugby/match/'+idLive+'/summary';
			infoMatch=[];
			getData(urlMatch,2);
}
//--------------
// update Compétition
    function updateComp(id) {
        if (id==undefined) iComp = (iComp+1) % nbComp;
//        if (idLive!=0) t.restart(cycle,60000)
//            else t.stop();
        var codeCup = rwc_index[idComp][iComp]; //[1][17];
        console.log(id,idComp,iComp);
        var urlRWC = 'http://cmsapi.pulselive.com/rugby/event/'+codeCup+'/schedule';
        listeMatchs=[];
        getData(urlRWC,1);
		if (idLive != 0) {
			var urlMatch = 'http://cmsapi.pulselive.com/rugby/match/'+idLive+'/summary';
			infoMatch=[];
			getData(urlMatch,2);
		}
    }
//--------------
// change comp
    function changeComp() {

    var svgInt = d3.select("#intervalle").append("svg")
    .attr('width',50).attr('height',30)
    .attr("position", 1)
    .append("g").raise()
    .attr('transform',function (d,i){ return ('translate('+ (30)+','+10+')');});

//var interG = svgInt.selectAll('g').data(IntervalData).enter()
//    .append('g')
//    .attr('transform',function (d,i){ return ('translate('+ (intWidth-20-i*25)+','+11+')');})
//    .on('click',click);
        
    svgInt.append('circle').attr('fill','#2E2D88')
        .attr('r',10)
        .on('click',updateComp)
        .on('mouseover',function(d,i){ d3.select(this).attr('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).attr('fill','#2E2D88');});
//        .on('mouseout',function(d,i){ d3.select(this).attr('fill',(a)=>{return (i==selInter)?'red':'#2E2D88';});});
 //.attr('cx',(d,i)=>{return width-i*25;}).attr('cy',15)
//    interG.append('text').attr('fill','white').style('text-anchor','middle')
//        .attr('dy','0.3em').text(d=>d.t).raise();
}
//----------
	function selPage(idPage) {
		console.log('Page : '+idPage);
		selMenu=idPage;
		switch (idPage) {
		  case 3 : 
	  		try { console.log(dataLive); } catch { dataLive = dataInfo; } /// a enlever !!!
			livePage();		break;
		}
	}
// ---------
	function livePage() {
		let size = 26,padding=4, space=0.9,centre=1.6, margeH = 20;
		largeur = (width-margin.left-margin.right-100); //console.log(largeur,width);
		let timeSize=25, scoreSize = 95;
        d3.select('#intervalle').remove();

        d3.select('#graphe').remove();
		let graph=svg.append('g').attr('id','graphe')
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		let listeG = graph.selectAll('g').data(dataLive.match.scores).enter()   /// a changer EP
			.append('g').attr('transform',(d,i)=>{return ('translate('+(i*(largeur/2+padding))+','+(margeH)+')');});
console.log('live page ...');
        //nom des équipes
        listeG.append('rect').attr('rx',3*padding).attr('ry',3*padding)
            .attr('width',largeur/2).attr('height',timeSize+scoreSize+padding).style('fill', '#0a88ff');
        listeG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',(d,i)=>{ return (largeur/2+(2*i-1)*scoreSize)/2;}).attr('y',(timeSize+scoreSize+padding)/centre) //.attr('id',(d)=>{return ('en0_'+d.matchId);})
            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'ccc';}).style('text-anchor', 'middle')
            .style('font-weight', 'bold')
            .text((d,i)=>(dataLive['match']['teams'][i]['name'])).style('font-size','4vw');
		
		// scores
		let scoreG = listeG.append('g') //.data(dataLive.match.scores).enter()   /// a changer EP
			.attr('transform',(d,i)=>{return ('translate('+((i+1)%2*(largeur/2-scoreSize))+','+(timeSize)+')');});
        scoreG.append('rect').attr('rx',2*padding).attr('ry',2*padding)
            .attr('width',scoreSize).attr('height',scoreSize+padding).style('fill', '#2255ff').raise();
        scoreG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',scoreSize/2).attr('y',scoreSize/2*centre) //.attr('id',(d)=>{return ('en0_'+d.matchId);})
            .style('fill', '#fff').style('text-anchor', 'middle')
            .style('font-weight', 'bold')
            .text(d=>d).style('font-size','6vw');

        //time
		let time = graph.append('g').attr("transform","translate("+(largeur/2-scoreSize)+","+(margeH)+")");
		let min= Math.trunc((dataLive.match.clock.secs)/60), sec=(dataLive.match.clock.secs)%60;
        time.append('rect').attr('rx',padding).attr('ry',padding)
            .attr('width',scoreSize*2+padding).attr('height',timeSize).style('fill', '#fff').raise();
        time.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',scoreSize+padding/2).attr('y',timeSize/2*centre).style('fill','#002').style('text-anchor', 'middle')
            .text((d)=>{ return min+' : '+(sec<9?'0':'')+sec;}).style('font-size','2vw');
			
		// les Essai Try
		let tryG = listeG.append('g')
			.attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(timeSize+scoreSize+2*padding)+')');});
        tryG.selectAll('g').data((d,i)=> {try { v=(dataLive.teams[i].scoring.Try[0]);return (dataLive.teams[i].scoring.Try);} catch(e){return [];};})
            .enter().append('g').each(function (a,c) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', (d,i)=> { return c>3?'#259':'000';}).raise();});
        tryG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding*centre)
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Try').style('font-size','1vw');
            
/*        let nPen0 = 0, nPen1=0;
        try { nPen0 = data.teams[0].scoring.Pen.length; } catch(e) {nPen0=0;}
        try { nPen1 = data.teams[1].scoring.Pen.length; } catch(e) {nPen1=0;}
        let nDG0 = 0, nDG1=0;
        try { nDG0 = data.teams[0].scoring.DG.length; } catch(e) {nDG0=0;}
        try { nDG1 = data.teams[1].scoring.DG.length; } catch(e) {nDG1=0;}
*/		
        // les Essai Drop
        let DrGG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize+5*padding)+')');});
        DrGG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].scoring.DG[0]);return (dataLive.teams[i].scoring.DG);} catch(e){return [];};})
            .enter().append('g').each(function (a,c) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#000').raise();});
        DrGG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding*centre)
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Drop').style('font-size','1vw');
        // les Pénélités
        let PenG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize+8*padding)+')');});
        PenG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].scoring.Pen[0]);return (dataLive.teams[i].scoring.Pen);} catch(e){return [];};})
            .enter().append('g').each(function (a,c,i) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#000').raise();});
        PenG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding*centre)
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Pen').style('font-size','1vw');

        let stadeG = graph.append('g').attr('transform',(d,i)=>{return ('translate('+(0)+','+(scoreSize+timeSize+16*padding)+')');});
      
        stadeG.append('rect').attr('width',largeur/10).attr('height',largeur/2)
            .style('fill','#192');
        stadeG.append('rect').attr('x',largeur/10+1).attr('width',largeur/10*4-1).attr('height',largeur/2)
            .style('fill','#192');
        stadeG.append('rect').attr('x',largeur/2+1).attr('width',largeur/10*4-1).attr('height',largeur/2)
            .style('fill','#192');
        stadeG.append('rect').attr('x',largeur/10*9+1).attr('width',largeur/10).attr('height',largeur/2)
            .style('fill','#192');

	}
//--------------
// Affichage de la liste des matches
//
	function affListe() {
        let titre = listeMatchs.event.label;
        console.log('affListe');
		idLive=0;
		for (m in listeMatchs.matches) {
			if (listeMatchs.matches[m].status != 'U' && listeMatchs.matches[m].status !='C') {
//				console.log(m);
				idLive = listeMatchs.matches[m].matchId;
				t = setInterval(cycle,60000);
				cycle();
			}
		}
			//console.log(idLive);
        if (listeMatchs.event.winningTeam!=null) titre += '/' + listeMatchs.event.winningTeam.name;
        d3.select("#h1").text(titre);
		color_status = { U:'#ffffff', C:'#aaaaaa',L1:'#004',L2:'#000', LHT:'#33ff33' }
		color_pool = { "Pool A":'#4078D3',"Pool 1":'#4078D3', "Pool B":'#2E5697',"Pool 2":'#2E5697',
        "Pool C":'#3767B5',"Pool 3":'#3767B5',"Pool D":'#4989F1','Poule 4':'#4989F1',"Pool 4":'#4989F1',"Pool E":'#5999F1',"Quarter-Finals":'#12223C',"Semi-Finals":'#555588',"Bronze Final": '#999','3rd Place Play-Off':'#999',"Final":'#c1a40e' }
//    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+((listeVal.length+1)*size));
		let size = 26,padding=2, largeur=110, space=0.9,centre=1.6;
		largeur = (width-margin.left-margin.right) /6; //console.log(largeur,width);
		var jour = new Date();	//console.log(jour.getTimezoneOffset(), jour);
        d3.select('#graphe').remove();
		let graph=svg.append('g').attr('id','graphe')
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		let listeG = graph.selectAll('g').data(listeMatchs.matches).enter()
			.append('g').attr('transform',(d,i)=>{return ('translate('+(2)+','+(i*size+padding/2)+')');});

        //equ 0 - nom
        listeG.append('rect').attr('x',0).attr('id','stat')
            .attr('width',largeur).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]); //'#0a88ff');
        listeG.append('text').attr('x',padding) //.attr('y',10)
            .attr('dx',(largeur-padding)/2).attr('y',size/centre).attr('id',(d)=>{return ('en0_'+d.matchId);})
            .style('fill', (d) => { return d.scores[0]>d.scores[1]?'#fff':'ccc';}).style('text-anchor', 'middle')
            .style('font-weight', (d) => { return d.scores[0]>d.scores[1]?'bold':'normal';})
            .text((d)=>(d['teams'][0]['name'])).style('font-size','11px');
        //equ 1 - nom
        listeG.append('rect').attr('x',largeur*2).attr('id','stat')
            .attr('width',largeur).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',padding) //.attr('y',10)
            .attr('dx',2*largeur+(largeur-padding)/2).attr('y',size/centre).attr('id',(d)=>{return ('en1_'+d.matchId);})
            .style('fill','#fff').style('text-anchor', 'middle').style('fill', (d) => { return d.scores[1]>d.scores[0]?'#fff':'ccc';})
            .style('font-weight', (d) => { return d.scores[1]>d.scores[0]?'bold':'normal';})
            .text((d)=>(d['teams'][1]['name'])).style('font-size','12px');
        //equ 0 : score
        listeG.append('rect').attr('x',largeur+padding).attr('id','stat')
            .attr('width',largeur/3).attr('height',size*space).style('fill',d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',padding).attr('id',(d)=>{return ('e0_'+d.matchId);}) //.attr('y',10)
            .attr('dx',largeur+(largeur/3-padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .style('fill', (d) => { return d.scores[0]>d.scores[1]?'#fff':'ccc';})
            .style('font-weight', (d) => { return d.scores[0]>d.scores[1]?'bold':'normal';})
            .text((d)=>(d['scores'][0])).style('font-size','12px');
        //equ 1 : score
        listeG.append('rect').attr('x',5*largeur/3-padding).attr('id','stat')
            .attr('width',largeur/3).attr('height',size*space).style('fill',d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',padding).attr('id',(d)=>{return ('e1_'+d.matchId);}) //.attr('y',10)
            .attr('dx',5*largeur/3+(largeur/3-3*padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .style('fill', (d) => { return d.scores[1]>d.scores[0]?'#fff':'ccc';})
            .style('font-weight', (d) => { return d.scores[1]>d.scores[0]?'bold':'normal';})
            .text((d)=>(d['scores'][1])).style('font-size','12px');
        //en cours ?
        listeG.append('rect').attr('x',4*largeur/3+2*padding).attr('rx',2*padding).attr('ry',2*padding)
            .attr('width',largeur/3-4*padding).attr('height',size*space).style('fill',(d)=>{return d.status=='C'?color_pool[d.eventPhase]:color_status[d.status];})
			.on('click',getInfo);
        listeG.append('text').attr('x',padding).attr('id',(d)=>{return ('m'+d.matchId);}) //.attr('y',10)
            .attr('dx',4*largeur/3+(largeur/3-3*padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .style('fill', '#fff').style('font-weight','normal')
//            .text('00:00').style('font-size','10px');
//            .text((d)=>(d.clock))
			.style('font-size','10px');

        //date/heure
        listeG.append('rect').attr('x',3*largeur+padding).attr('id','stat')
            .attr('width',largeur).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]); //'#0a88ff');
        listeG.append('text').attr('x',3*largeur +padding) //.attr('y',10)
            .attr('dx',(largeur-padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .text((d)=>{ jour.setTime(d.time.millis); return jour.toLocaleDateString()+' / '+jour.toLocaleTimeString();}).style('font-size','11px');

        //lieu
        listeG.append('rect').attr('x',4*largeur+2*padding).attr('id','stat')
            .attr('width',largeur*3).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]); //'#0a88ff');
        listeG.append('text').attr('x',4*largeur +4*padding) //.attr('y',10)
            .attr('dx',padding).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'start')
            .text((d)=>{ return d.venue.name+' ['+d.attendance+'] ('+d.venue.city+'/'+d.venue.country+' )';}).style('font-size','11px');

			
/*    paramG.append('circle').attr('cx',15).attr('cy',size/2).style('r',size/3).style('fill','#fff');
    paramG.append('svg').attr('width',size/2).attr('height',size/2)
        .attr('x',size/4).attr('y',size/4).attr('id',(d,i)=>{ return ('sel'+i);})
        .attr('class',(d)=>{return ('icon fas fa-'+icon[d.select]);}).style('color',d=>{return couleur[d.select];});
    paramG.append('circle').attr('cx',15).attr('cy',size/2).style('r',size/3).style('fill','#fff')
        .on('click',selectVal).style('opacity',0.1);
*/	}
//--------------
// Get Info
	function getInfo(d,i) {
        var urlMatch = 'http://cmsapi.pulselive.com/rugby/match/'+d.matchId+'/summary';
        dataInfo=[];
        getData(urlMatch,3);

	}
    function affInfo() {
        clock=dataInfo.match.clock.label;
        let mId = '#m'+dataInfo.match.matchId;
        console.log(clock,mId);
        d3.select(mId).text(clock);
        affInfoLive(dataInfo);
    }
    function affInfoLive(data) {
        let nTry0 = 0, nTry1=0;
        try { nTry0 = data.teams[0].scoring.Try.length; } catch(e) {nTry0=0;}
        try { nTry1 = data.teams[1].scoring.Try.length; } catch(e) {nTry1=0;}
        let nPen0 = 0, nPen1=0;
        try { nPen0 = data.teams[0].scoring.Pen.length; } catch(e) {nPen0=0;}
        try { nPen1 = data.teams[1].scoring.Pen.length; } catch(e) {nPen1=0;}
        let nDG0 = 0, nDG1=0;
        try { nDG0 = data.teams[0].scoring.DG.length; } catch(e) {nDG0=0;}
        try { nDG1 = data.teams[1].scoring.DG.length; } catch(e) {nDG1=0;}

        let infoStr=data.match.eventPhase+': '+data.officials[0].official.name.display+' - '
            +data.match.teams[0].name+' ['+nTry0+']'+' ['+nPen0+']'+' ['+nDG0+']'
            +' / '
            +data.match.teams[1].name+' ['+nTry1+']'+' ['+nPen1+']'+' ['+nDG1+']'
            +'  ...        ([Try][Pen][Drop])'
        d3.select('#infoLive').text(infoStr);
    }
    function affLive() {
        clock=dataLive.match.clock.label;
        let mId = '#m'+dataLive.match.matchId;
        console.log(clock,mId);
        d3.select(mId).text(clock);
		if (dataLive.match.status =='C') {
			idLive = 0;
			clearInterval(t);
		}
        let nTry0 = 0, nTry1=0;
        try { nTry0 = dataLive.teams[0].scoring.Con.length; }
        catch(e) {nTry0=0;}

        try { nTry1 = dataLive.teams[1].scoring.Con.length; }
        catch(e) {nTry1=0;}
        console.log(nTry0,nTry1);
        let e0Id = '#e0_'+dataLive.match.matchId, e1Id = '#e1_'+dataLive.match.matchId;
        d3.select(e0Id).text(dataLive.match.scores[0]);
        d3.select(e1Id).text(dataLive.match.scores[1]);
        let en0Id = '#en0_'+dataLive.match.matchId, en1Id = '#en1_'+dataLive.match.matchId;
        d3.select(en0Id).text(dataLive.match.teams[0].name+' ['+nTry0+']');
        d3.select(en1Id).text(dataLive.match.teams[1].name+' ['+nTry1+']');
        affInfoLive(dataLive);
		livePage();
    }
//--------------
// Get Data from url
//
	function getData(url, type) {
		console.log(url);
		var opt = fetch(url, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',})})
		.then(response => { return response.json();})
		.then(data => {
		// JSON Data
			console.log(data);
			switch (type) {
				case 1: listeMatchs = data;
						dispatch.call('load');
						break;
				case 2: dataLive = data;
						dispatch.call('live');
						break;
                case 3: dataInfo = data;
                        dispatch.call('match');
                        break;
			}
/*			listeVal.forEach( (a,i) => {
				let o = data.find( f => { return (f.dataReference == a.nom);});
				if (o != undefined) {
					listeVal[i]['unit']= o.unit;
					listeVal[i]['values']= o.values;
				}
			});
		    infoG.select('text').text("Données disponibles !");
            infoG.select('circle').attr('fill','#03C03C');
            config.dataOK=true;
			switch(cumul) {
            case 2:
				DivData = data.slice();
				divCompute();
                dataCompute(); //couleurCompute();
				selGraphe=0;
				dispatch.call('load');
				break;
            case 1:
                CumulData = data.slice();
                cumulCompute();
				}
				break;
            case 0:
                AllData = data.slice();
                start(url2,1);    //0-variable 1-cumul 2-diviseur
				break;
			}
*/		})
		.catch(err => {
		// Do something for an error here
			console.log(err);
		});
	}

  </script>
</body>
</html>