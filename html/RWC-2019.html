<!DOCTYPE html>
<title>RWC</title>
<meta name="description" content="Suivi de match Rugby World Cup 2019.">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>RWC 2019 - JAPON</title>
<style>
@import url(../css/dsp.css);

#chart {
	position : absolute;
	background-color : lightcyan;
}
#intervalle {
    position: absolute;
    top: 25px;
    right: 30px;
}
#infoLive {
    position: absolute;
    top: 25px;
    font: 10px sans-serif;
    left: 20px;
    font-family: "helvetica neue", sans-serif;
    color: #191970;
}
text {
  font: 10px sans-serif;
}
.label {
    fill: #777;
}
.rky header {
    background: #1e3F5E;
}
table {
    font-family: "helvetica neue", sans-serif;
}
</style>
<body>
<header>
  <div id='h1'>Rugby World Cup</div>
  <aside >Septembre, 2019<br><br>| v 5.41</aside>
  <div id='menu'></div>
</header>
<footer>
    <aside>(c) e-Coucou | y2kJ | Live Data</aside>
    <div id="info"></div>
</footer>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js" charset="utf-8"></script>
	<script src="../js/menu.js" charset="utf-8"></script>
	<script defer src="../js/all.js"></script>
    <div id="chart"></div>
    <div id="infoLive">Live info ...</div>
    <div id='intervalle'></div>
  <script type="text/javascript">
	var rwc_index = [[ "1","2","3","4","5","952","1023","1238","1558"],["145","344","854","883","913","927","965","1005","1054","1077","1164","1184","1243","1244","1622","1623","1782","1783"],["1183","1236","1296","1557","364","714","855","886","926","940","970","995","1056","1135","1697","1764","1807"],["1577"],["925","957","971","1006","1072","1130","1166","1235","1273","1569","1653","1769"]]; // rwc , six nation , 4 nations , xx , wrc pacific
    var idComp=0, nbComp=rwc_index[idComp].length, iComp=nbComp-1;
	var idLive=0, clock='', selMenu=0;
	var teams = [], idRank=0, dataRank=[],teamsInfo=[], nbTeams=-1, dataStandings=[];
    var url = '';
	var dataTimeline=[];
    // format ...
    let valFormat = (a) => { 
        let r = (a>100) ? Math.round(a) : ( (a>1)? Math.round(a*100.0)/100 : Math.round(a*1000.0)/1000);
        return String(r).replace(/(.)(?=(\d{3})+$)/g,'$1 ');
//        return r;
        }
	// Chart dimensions.
	var margin = {top: 20, right: 20, bottom: 50, left: 50},
		width = window.innerWidth; // - margin.right-margin.left,
		height = 1350 - margin.top - margin.bottom;
	// Create the SVG container and set the origin.
    var svg = d3.select("#chart").append("svg")
        .attr("width", width -5) //+ margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("position", 2);

	var dispatch = d3.dispatch('load','match','live','rank','timeline');
    dispatch.on('load',affListe);
    dispatch.on('match',affInfo);
    dispatch.on('live',affLive);
    dispatch.on('rank',updateRank);
    dispatch.on('timeline',affTimeline);
	
	var listeMatchs=[],dataInfo=[];
    var t = setInterval(cycle,5000), t_veille = setInterval(veille,300000);
    clearInterval(t);
    standings();
	menu(selMenu);changeComp();
    updateComp(1);

//--------------
// cycle
async function cycle() {
//    updateComp(0);
	clearInterval(t_veille);
	var urlMatch = 'http://cmsapi.pulselive.com/rugby/match/'+idLive+'/summary';
			//infoMatch=[];
	getData(urlMatch,2);
	await timeline(idLive);
}
// veille
function veille() {
        var urlRWC = 'http://cmsapi.pulselive.com/rugby/event/'+rwc_index[idComp][iComp]+'/schedule';
		getData(urlRWC,1);
		console.log('veille....');
}
// standings
function standings() {
    var urlStandings = 'http://cmsapi.pulselive.com/rugby/event/'+rwc_index[idComp][iComp]+'/standings';
    getData(urlStandings,6);
}
// timeline
async function timeline(id) {
	console.log('get Timeline ...', id);
	var urlTimeline = 'http://cmsapi.pulselive.com/rugby/match/'+id+'/timeline';
	getData(urlTimeline,5);
}
function affTimeline() {
	try {
		let l=dataTimeline.timeline.length;
		console.log('time line : ',dataTimeline);
//        selPage(3);
	} catch(e) {console.log('timeline out');}
}
//--------------
// update Compétition
    function updateComp(id) {
        if (id==undefined) iComp = (iComp+1) % nbComp;
        var codeCup = rwc_index[idComp][iComp]; //[1][17];
        console.log(id,idComp,iComp);
        var urlRWC = 'http://cmsapi.pulselive.com/rugby/event/'+codeCup+'/schedule';
        getData(urlRWC,1);
		if (idLive != 0) {
			var urlMatch = 'http://cmsapi.pulselive.com/rugby/match/'+idLive+'/summary';
			infoMatch=[];
			getData(urlMatch,2);
		}
    }
//--------------
// change comp
    function changeComp() {

    var svgInt = d3.select("#intervalle").append("svg")
    .attr('width',50).attr('height',30)
    .attr("position", 1)
    .append("g").raise()
    .attr('transform',function (d,i){ return ('translate('+ (30)+','+10+')');});

//var interG = svgInt.selectAll('g').data(IntervalData).enter()
//    .append('g')
//    .attr('transform',function (d,i){ return ('translate('+ (intWidth-20-i*25)+','+11+')');})
//    .on('click',click);
        
    svgInt.append('circle').attr('fill','#2E2D88')
        .attr('r',10)
        .on('click',updateComp)
        .on('mouseover',function(d,i){ d3.select(this).attr('fill','#FE6F5E');})
        .on('mouseout',function(d,i){ d3.select(this).attr('fill','#2E2D88');});
//        .on('mouseout',function(d,i){ d3.select(this).attr('fill',(a)=>{return (i==selInter)?'red':'#2E2D88';});});
 //.attr('cx',(d,i)=>{return width-i*25;}).attr('cy',15)
//    interG.append('text').attr('fill','white').style('text-anchor','middle')
//        .attr('dy','0.3em').text(d=>d.t).raise();

}
//----------
	function selPage(idPage) {
		//console.log('Page : '+idPage);
		selMenu=idPage;
		switch (idPage) {
		  case 3 : 
//		  click(); //epxxx
	  		try { console.log('live!',dataLive); } catch(e) { console.log('no live!'); dataLive = dataInfo; } /// a enlever !!!
			livePage();
			break;
		}
	}
// ---------
	function livePage() {
		let padding=width/420, space=0.9,centre=1.6, margeH = 5;
		var largeur = (width-margin.left-margin.right); //console.log(largeur,width);
		let timeSize=width/40, scoreSize = width/15; //25 - 95;
		let teamColor=['#006','#0bc'];
        d3.select('#intervalle').remove();
        d3.select('#infoLive').remove();

        d3.select('#graphe').remove();
		graph=svg.append('g').attr('id','graphe')
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		let listeG = graph.selectAll('g').data(dataLive.match.scores).enter()   /// a changer EP
			.append('g').attr('transform',(d,i)=>{return ('translate('+(i*(largeur/2+padding))+','+(margeH)+')');}).attr('class','cScores');
		//--------------------------------------
		console.log('live page ...');
        //nom des équipes
        listeG.append('rect').attr('rx',3*padding).attr('ry',3*padding)
            .attr('width',largeur/2).attr('height',timeSize+scoreSize+padding).style('fill', (d,i)=>teamColor[i]); //'#0a88ff');
        listeG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',(d,i)=>{ return (largeur/2+(2*i-1)*scoreSize)/2;}).attr('y',(timeSize+scoreSize)/2) //.attr('id',(d)=>{return ('en0_'+d.matchId);})
            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'ccc';}).style('text-anchor', 'middle')
            .style('font-weight', 'bold').style('dominant-baseline','middle')
            .text((d,i)=>(dataLive['match']['teams'][i]['name'])).style('font-size','3.5vw');
        // rank
        listeG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',(d,i)=>{ return (i*largeur/2-2*(2*i-1)*padding)}).attr('y',(timeSize+scoreSize)).attr('dy','-0.76em')
            .style('fill', '#fff').style('text-anchor', (d,i)=> i==0?'begin':'end')
            .style('font-weight', 'normal')
            .text((d,i)=>{ id=dataLive.match.teams[i].id;
                         return ('rank: '+teamsInfo[id].current.pos+' ('+valFormat(teamsInfo[id].current.pts)+') (#'+teamsInfo[id].matches+')');})
            .style('font-size','1vw');
        // POOL
        listeG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',(d,i)=>{ return (i*largeur/2-2*(2*i-1)*padding)}).attr('y', '1.5em') //(3*padding))
            .style('fill', '#fff').style('text-anchor', (d,i)=> i==0?'begin':'end')
            .style('font-weight', 'normal').text((d,i)=> dataLive.match.eventPhase )
            .style('font-size','1vw');

		// scores
		let scoreG = listeG.append('g') //.data(dataLive.match.scores).enter()   /// a changer EP
			.attr('transform',(d,i)=>{return ('translate('+((i+1)%2*(largeur/2-scoreSize))+','+(timeSize)+')');});
        scoreG.append('rect').attr('rx',2*padding).attr('ry',2*padding)
            .attr('width',scoreSize).attr('height',scoreSize).style('fill', '#2255ff').raise();
        scoreG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',scoreSize/2).attr('y',scoreSize/2) //.attr('id',(d)=>{return ('en0_'+d.matchId);})
            .style('fill', '#fff').style('text-anchor', 'middle').style('dominant-baseline','middle')
            .style('font-weight', 'bold')
            .text(d=>d).style('font-size','4vw');

        //time
		let time = graph.append('g').attr("transform","translate("+(largeur/2-scoreSize/2)+","+(margeH)+")");
		let min=0,sec=0;
		try {
			min= Math.trunc((dataLive.match.clock.secs)/60); sec=(dataLive.match.clock.secs)%60;
		} catch(e) {}
        time.append('rect').attr('rx',padding).attr('ry',padding).attr('y',2)
            .attr('width',scoreSize+padding).attr('height',timeSize-3).style('fill', '#fff').raise();
        time.append('text').attr('x',0).style('dominant-baseline','middle')
            .attr('dx',scoreSize/2+padding/2).attr('y',timeSize/2).style('fill','#002').style('text-anchor', 'middle')
            .text((d)=>{ return min+' : '+(sec<9?'0':'')+sec;}).style('font-size','1.2vw');
			
		// les Essai Try
		let tryG = listeG.append('g')
			.attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(timeSize+scoreSize+2*padding)+')');});
        tryG.selectAll('g').data((d,i)=> {try { v=(dataLive.teams[i].scoring.Try[0]);return (dataLive.teams[i].scoring.Try);} catch(e){return [];};})
            .enter().append('g').each(function (a,c) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', (d,i)=> { return c>3?'#259':'000';}).raise();});
        tryG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding).style('dominant-baseline','middle')
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Try').style('font-size','0.6vw');
            
        // les Essai Drop
        let DrGG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize+5*padding)+')');});
        DrGG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].scoring.DG[0]);return (dataLive.teams[i].scoring.DG);} catch(e){return [];};})
            .enter().append('g').each(function (a,c) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#000').raise();});
        DrGG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding).style('dominant-baseline','middle')
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Drop').style('font-size','0.6vw');
        // les Pénalités
        let PenG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize+8*padding)+')');});
        PenG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].scoring.Pen[0]);return (dataLive.teams[i].scoring.Pen);} catch(e){return [];};})
            .enter().append('g').each(function (a,c,i) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#000').raise();});
        PenG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding).style('dominant-baseline','middle')
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Pen').style('font-size','0.6vw');
        // les conversions ...
        let ConG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize+11*padding)+')');});
        ConG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].scoring.Con[0]);return (dataLive.teams[i].scoring.Con);} catch(e){return [];};})
            .enter().append('g').each(function (a,c,i) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#000').raise();});
        ConG.append('text').attr('x',0) //.attr('y',10)
            .attr('dx',0).attr('y',padding).style('dominant-baseline','middle')
            .style('fill', '#000').style('text-anchor', 'left').style('font-weight', 'normal')
            .text('Con').style('font-size','0.6vw');
        // les Sanctions
        let YCG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize-2*padding)+')');});
        YCG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].disciplinary.YC[0]);return (dataLive.teams[i].disciplinary.YC);} catch(e){return [];};})
            .enter().append('g').each(function (a,c,i) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#ff0').raise();});
        let RCG = listeG.append('g') 
            .attr('transform',(d,i)=>{return ('translate('+(i==0?(largeur/2-scoreSize):(padding))+','+(scoreSize+timeSize-4*padding)+')');});
        YCG.selectAll('g').data((d,i)=> {try {console.log(dataLive.teams[i].disciplinary.RC[0]);return (dataLive.teams[i].disciplinary.RC);} catch(e){return [];};})
            .enter().append('g').each(function (a,c,i) {d3.select(this)
            .append('rect').attr('x',(d,j)=>{ return (2*(c+3)*padding);}) //.attr('ry',2*padding)
            .attr('width',padding*2-1).attr('height',padding*2).style('fill', '#f00').raise();});

		//-----------------------------
		// le stade !
		let stadeSize = largeur/3, poteau, tlSpace = width/14;
		let hScores = $('.cScores')[0].getBBox().height;
		//console.log('la taille des scores ... : ',$('.cScores')[0].getBBox().height);
		var x = d3.scaleLinear()
			.domain([-10, 110]).nice()
			.range([0, stadeSize]);
		let stadeLargeur = (x(100)-x(0))*.7;
		var y = d3.scaleLinear()
			.domain([0, 70]).nice()
			.range([stadeLargeur, 0]);
		let lineDash = ['','4,1','12,5'];
		let stadeLine = [[22,0,22,70,0],[78,0,78,70,0],[40,0,40,70,1],[60,0,60,70,1],[0,5,100,5,2],[0,65,100,65,2],[0,15,100,15,2],[0,55,100,55,2]],
			stadePoteau = [[0,35-2.8],[0,35+2.8],[100,35-2.8],[100,35+2.8]];

        let stadeG = graph.append('g').attr('transform',(d,i)=>{return ('translate('+((largeur-stadeSize)/2)+','+(hScores + tlSpace + 1*padding )+')');});//(scoreSize+timeSize+25*padding)+')');});
        stadeG.append('rect').attr('width',x(0)).attr('height',stadeLargeur)
            .style('fill','#071');
        stadeG.append('rect').attr('x',x(0)+1).attr('width',x(40)-1).attr('height',stadeLargeur)
            .style('fill','#192');
        stadeG.append('rect').attr('x',x(50)+1).attr('width',x(40)-1).attr('height',stadeLargeur)
            .style('fill','#192');
        stadeG.append('rect').attr('x',x(100)+1).attr('width',x(0)-1).attr('height',stadeLargeur)
            .style('fill','#071');
		stadeG.selectAll('g').data(stadePoteau).enter()
			.append('circle').attr('cx',d=>x(d[0])).attr('cy',d=>y(d[1])).attr('r',3).style('fill','#fff');
		stadeG.selectAll('g').data(stadeLine).enter()
			.append('line').attr('x1',d=>x(d[0])).attr('y1',d=>y(d[1])).attr('x2',d=>x(d[2])).attr('y2',d=>y(d[3])).style('stroke','#fff').style('stroke-dasharray',d=>lineDash[d[4]]);
		//les infos sur le stade 	
		stadeG.append('text').attr('x',stadeSize/2).attr('y',stadeLargeur).attr('dy','1em').style('text-anchor','middle').style('fill','#005').text(dataLive.match.venue.name).style('font-size','2.5vw').style('font-weight','bold');
		stadeG.append('text').attr('x',stadeSize/2).attr('y',stadeLargeur).attr('dy','3em').style('text-anchor','middle').style('fill','#005').text(dataLive.match.attendance+' spectateurs').style('font-size','1.5vw');
		
		let officialG = stadeG.append('g').attr('transform',(d)=>{ return 'translate('+(stadeSize/2)+','+(stadeLargeur*1.33)+')';});
		officialG.selectAll('g').data(dataLive.officials).enter()
			.append('text').attr('x',0).attr('y',(d,i)=>i*largeur/60).style('text-anchor','middle').style('fill','#501').text((d)=>{return d.official.name.display+' - '+d.position+' ['+d.official.country+']';}).style('font-size','1vw');
		
		//-----------------------
		// on affiche les essai / les pé,nalité et les drops ... ?
		
		for (t in [0,1]) {
			try {
				stadeG.append('g').selectAll('ellipse').data(dataLive.teams[t].scoring.Try).enter()
					.append('ellipse').attr('cx',d=>x(d.position.x)).attr('cy',(d,i)=>y(d.position.y*.7)).attr('rx',5).attr('ry',3).style('fill',teamColor[t]);
			} catch(e) {}
			try {
				stadeG.append('g').selectAll('ellipse').data(dataLive.teams[t].scoring.Pen).enter()
					.append('ellipse').attr('cx',d=>x(d.position.x)).attr('cy',d=>y(d.position.y*.7)).attr('rx',5).attr('ry',3).style('fill',teamColor[t]);
			} catch(e) {}
			try {
				stadeG.append('g').selectAll('ellipse').data(dataLive.teams[t].scoring.DG).enter()
					.append('ellipse').attr('cx',d=>x(d.position.x)).attr('cy',d=>y(d.position.y*.7)).attr('rx',5).attr('ry',3).style('fill',teamColor[t]);
			} catch(e) {}
		}
		//on affiche les joueurs ...
        let teamG = graph.append('g').attr('transform',(d,i)=>{return ('translate('+(0)+','+(scoreSize+timeSize+5*padding)+')');});
		let motm=0;
		try { motm = dataLive.motm.motm.id; } catch(e) {}
		for (t in [0,1]) {
			let captain = dataLive.teams[t].teamList.captainId;
			teamG.selectAll('g').data(dataLive.teams[t].teamList.list.sort((a, b) => (Number(a.number) > Number(b.number)) ? 1 : -1)).enter()
				.append('text').attr('x',t*(largeur))
				.attr('dy',(d,i)=> {return (i*largeur/60);}).attr('y','0.5em')
				.style('fill', (d)=>{return d.player.id==motm?'#d00':'#000';})
				.style('text-anchor', t==1?'end':'begin').style('font-weight', (d)=>{return ((d.player.id==captain)||(d.player.id==motm))?'bold':'normal';})
				.text((d)=>{return (t==0?((Number(d.number)>9?'':'0')+d.number+' '):'')+d.player.name.display+'  - '+d.positionLabel+' ('+d.player.age.years+' ans)'+(t==1?((Number(d.number)>9?' ':' 0')+d.number+' '):'');})
				.style('font-size','1vw');
		}
        // ranking de la poule ..
        let pool = dataLive.match.eventPhase;
        let f = dataStandings.tables.find(v=>v.label==pool);
        /*
        let poolG = stadeG.append('g').attr('transform',(d)=>{ return 'translate('+(0)+','+(stadeLargeur*2)+')';});
        poolG.selectAll('g').data(f.entries).enter()
            .append('text').attr('x',0).attr('y',(d,i)=>i*largeur/50).style('text-anchor','begin').style('fill','#004').style('font-weight','bold')
            .text((d)=>{return d.team.name+' - '+d.points+' ['+d.won+'/'+d.lost+'/'+d.drawn+']';}).style('font-size','2vw');
        */
        // tableau de Pool !
        let poolH = ['R','Equipe','Play','Win','Lost','Nul','Pour','Contre','Try','Against','Bonus','Points'];
        var table =  stadeG.append('g').style('fill','black').attr('transform',(d)=>{ return 'translate('+(stadeSize*(-0.2))+','+(stadeLargeur*1.9)+')';})
            .append("foreignObject")
            .attr("width", stadeSize*1.4)
            .attr("height", '12vw')
            .style('background-color','#007')
            .append("xhtml:table");

        let thead = table.style('font-size','0.9vw').style('width','100%').style('height','100%').append('thead');
            thead.append('tr').style('background-color','black').style('color','white').selectAll('th').data(poolH).enter()
                .append('th').text((d)=>{return d;}).style('padding-right','7px').style('padding-left','7px');
        let tbody = table.append('tbody');
        let tr = tbody.selectAll('tr').data(f.entries).enter().append('tr').style('background-color','#cbf').style('color','black');
            tr.append('th').text((d)=>{return d.positionLabel;});
            tr.append('th').text((d)=>{return d.team.name;}).style('font-size','1.1vw').style('text-align','left');
            tr.append('th').text((d)=>{return d.played;});
            tr.append('th').text((d)=>{return d.won;});
            tr.append('th').text((d)=>{return d.lost;});
            tr.append('th').text((d)=>{return d.drawn;});
            tr.append('th').text((d)=>{return d.pointsFor;});
            tr.append('th').text((d)=>{return d.pointsAgainst;});
            tr.append('th').text((d)=>{return d.triesFor;});
            tr.append('th').text((d)=>{return d.triesAgainst;});
            tr.append('th').text((d)=>{return d.bonusPoints;});
            tr.append('th').text((d)=>{return d.points;}).style('font-size','1.1vw');
		// on affiche le live
		try {
            let l=dataTimeline.timeline.length, nbTL = Math.trunc(tlSpace/10-0.5);
			var tlFilter = dataTimeline.timeline.filter((x,i)=>{ return (i>= (l-nbTL-1) && (i!=(l-1)));});
			console.log(tlFilter);
			let infoG = stadeG.append('g').attr('transform','translate(0,'+(-tlSpace+padding)+')')
                    .selectAll('g').data(tlFilter.sort((a, b) => (Number(a.time.secs) > Number(b.time.secs)) ? -1 : 1)).enter();
				infoG.append('rect').attr('width',stadeSize).attr('height',tlSpace-2*padding).style('fill','#259');
				infoG.append('text').text((d)=> {console.log(d.type); return (d.time.label+' ['+dataInfo.match.teams[d.teamIndex].name+'] '+d.typeLabel+' - '+d.info);}).attr('id','infoTimeline')
					.style('fill','white').style('dominant-baseline','middle').style('text-anchor','start')
					.attr('y',(d,i)=>{ return ((i+1))+'em';}).attr('x','10px').style('font-size','1.5vw)');
			stadeG.append('g')//.selectAll('circle').data(dataTimeline.timeline[l-1]).enter()
				.append('circle').attr('cx',x(tlFilter[nbTL-1].position.x)).attr('cy',y(tlFilter[nbTL-1].position.y*.7)).attr('r',5).style('fill','red');
			}
		catch(e) {console.log('aff timeline out');}
	
	}
  	function updateRank() {
        teamsInfo[dataRank.team.id]=dataRank;
        nbTeams--;
        if (nbTeams==0) computeScore();
    }
    function computeScore() {
		//console.log(teamsInfo);
		console.log('Info team lus');
	}
//--------------
// Affichage de la liste des matches
//
	function affListe() {
        console.log('affListe');
        let titre = listeMatchs.event.label;
		idLive=0;
		for (m in listeMatchs.matches) {
			if (listeMatchs.matches[m].status != 'U' && listeMatchs.matches[m].status !='C') {
//				console.log(m);
				idLive = listeMatchs.matches[m].matchId;
				getMatch(idLive);
				t = setInterval(cycle,5000);
				cycle();
			}
		}
		teams=[];
        teamsInfo=[]; nbTeams=0;
        listeMatchs.matches.forEach((v)=>{
                if (teams.find((a)=>{ return v.teams[0].id===a;}) == undefined)  { teams.push(v.teams[0].id);   }
                if (teams.find((a)=>{ return v.teams[1].id===a;}) == undefined)  { teams.push(v.teams[1].id);   }
		  }); //console.log(teams);
        nbTeams=teams.length-1;
		teams.forEach((t)=>{
            if (t!=0) {
                let urlRank='http://cmsapi.pulselive.com/rugby/team/'+t+'/ranking';
                getData(urlRank,4);
            }
        });
			//console.log(idLive);
        if (listeMatchs.event.winningTeam!=null) titre += '/' + listeMatchs.event.winningTeam.name;
        d3.select("#h1").text(titre);
		color_status = { U:'#ffffff', C:'#aaaaaa',L1:'#004',L2:'#000', LHT:'#33ff33' }
		color_pool = { "Pool A":'#4078D3',"Pool 1":'#4078D3', "Pool B":'#2E5697',"Pool 2":'#2E5697',
        "Pool C":'#3767B5',"Pool 3":'#3767B5',"Pool D":'#4989F1','Poule 4':'#4989F1',"Pool 4":'#4989F1',"Pool E":'#5999F1',"Quarter-Finals":'#12223C',"Semi-Finals":'#555588',"Bronze Final": '#999','3rd Place Play-Off':'#999',"Final":'#c1a40e' }
//    svg.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+((listeVal.length+1)*size));
		let size = 26,padding=2, largeur=110, space=0.9,centre=1.6;
		largeur = (width-margin.left-margin.right) /6; //console.log(largeur,width);
		var jour = new Date();	//console.log(jour.getTimezoneOffset(), jour);
        d3.select('#graphe').remove();
		var graph=svg.append('g').attr('id','graphe')
			.attr("transform", "translate(" + 0 + "," + (margin.top+30) + ")");

		let listeG = graph.selectAll('g').data(listeMatchs.matches).enter()
			.append('g').attr('transform',(d,i)=>{return ('translate('+(2)+','+(i*size+padding/2)+')');});

        //equ 0 - nom
        listeG.append('rect').attr('x',0).attr('id','stat')
            .attr('width',largeur).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]); //'#0a88ff');
        listeG.append('text').attr('x',padding) //.attr('y',10)
            .attr('dx',(largeur-padding)/2).attr('y',size/centre).attr('id',(d)=>{return ('en0_'+d.matchId);})
            .style('fill', (d) => { return d.scores[0]>d.scores[1]?'#fff':'ccc';}).style('text-anchor', 'middle')
            .style('font-weight', (d) => { return d.scores[0]>d.scores[1]?'bold':'normal';})
            .text((d)=>(d['teams'][0]['name'])).style('font-size','11px');
        //equ 1 - nom
        listeG.append('rect').attr('x',largeur*2).attr('id','stat')
            .attr('width',largeur).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',padding) //.attr('y',10)
            .attr('dx',2*largeur+(largeur-padding)/2).attr('y',size/centre).attr('id',(d)=>{return ('en1_'+d.matchId);})
            .style('fill','#fff').style('text-anchor', 'middle').style('fill', (d) => { return d.scores[1]>d.scores[0]?'#fff':'ccc';})
            .style('font-weight', (d) => { return d.scores[1]>d.scores[0]?'bold':'normal';})
            .text((d)=>(d['teams'][1]['name'])).style('font-size','12px');
        //equ 0 : score
        listeG.append('rect').attr('x',largeur+padding).attr('id','stat')
            .attr('width',largeur/3).attr('height',size*space).style('fill',d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',padding).attr('id',(d)=>{return ('e0_'+d.matchId);}) //.attr('y',10)
            .attr('dx',largeur+(largeur/3-padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .style('fill', (d) => { return d.scores[0]>d.scores[1]?'#fff':'ccc';})
            .style('font-weight', (d) => { return d.scores[0]>d.scores[1]?'bold':'normal';})
            .text((d)=>(d['scores'][0])).style('font-size','12px');
        //equ 1 : score
        listeG.append('rect').attr('x',5*largeur/3-padding).attr('id','stat')
            .attr('width',largeur/3).attr('height',size*space).style('fill',d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',padding).attr('id',(d)=>{return ('e1_'+d.matchId);}) //.attr('y',10)
            .attr('dx',5*largeur/3+(largeur/3-3*padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .style('fill', (d) => { return d.scores[1]>d.scores[0]?'#fff':'ccc';})
            .style('font-weight', (d) => { return d.scores[1]>d.scores[0]?'bold':'normal';})
            .text((d)=>(d['scores'][1])).style('font-size','12px');
        //en cours ?
        listeG.append('rect').attr('x',4*largeur/3+2*padding).attr('rx',2*padding).attr('ry',2*padding)
            .attr('width',largeur/3-4*padding).attr('height',size*space).style('fill',(d)=>{return d.status=='C'?color_pool[d.eventPhase]:color_status[d.status];})
			.on('click',getInfo)
			.on('mouseover',function(d,i){ d3.select(this).style('fill','#FE6F5E');})
			.on('mouseout',function(d,i){ d3.select(this).style('fill',(d)=>{return d.status=='C'?color_pool[d.eventPhase]:color_status[d.status];});});

        listeG.append('text').attr('x',padding).attr('id',(d)=>{return ('m'+d.matchId);}) //.attr('y',10)
            .attr('dx',4*largeur/3+(largeur/3-3*padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .style('fill', '#fff').style('font-weight','normal')
//            .text('00:00').style('font-size','10px');
//            .text((d)=>(d.clock))
			.style('font-size','10px');

        //date/heure
        listeG.append('rect').attr('x',3*largeur+padding).attr('id','stat')
            .attr('width',largeur).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]);
        listeG.append('text').attr('x',3*largeur +padding) //.attr('y',10)
            .attr('dx',(largeur-padding)/2).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'middle')
            .text((d)=>{ jour.setTime(d.time.millis); return jour.toLocaleDateString()+' / '+jour.toLocaleTimeString();}).style('font-size','11px');

        //lieu
        listeG.append('rect').attr('x',4*largeur+2*padding).attr('id','stat')
            .attr('width',largeur*3).attr('height',size*space).style('fill', d=>color_pool[d.eventPhase]); //'#0a88ff');
        listeG.append('text').attr('x',4*largeur +4*padding) //.attr('y',10)
            .attr('dx',padding).attr('y',size/centre).style('fill','#fff').style('text-anchor', 'start')
            .text((d)=>{ return d.venue.name+' ['+d.attendance+'] ('+d.venue.city+'/'+d.venue.country+' )';}).style('font-size','11px');

			
/*    paramG.append('circle').attr('cx',15).attr('cy',size/2).style('r',size/3).style('fill','#fff');
    paramG.append('svg').attr('width',size/2).attr('height',size/2)
        .attr('x',size/4).attr('y',size/4).attr('id',(d,i)=>{ return ('sel'+i);})
        .attr('class',(d)=>{return ('icon fas fa-'+icon[d.select]);}).style('color',d=>{return couleur[d.select];});
    paramG.append('circle').attr('cx',15).attr('cy',size/2).style('r',size/3).style('fill','#fff')
        .on('click',selectVal).style('opacity',0.1);
*/	}
//--------------
// Get Info
async function getInfo(d,i) {
        console.log('getInfo');
        await timeline(d.matchId);
		await getMatch(d.matchId);
	}
async function getMatch(id) {
    var urlMatch = 'http://cmsapi.pulselive.com/rugby/match/'+id+'/summary';
    dataInfo=[];
    getData(urlMatch,3);
}
async function affInfo() {
        try { clock=dataInfo.match.clock.label; } catch(e) {clock='00:00';}
        let mId = '#m'+dataInfo.match.matchId;
        //console.log(clock,mId);
        d3.select(mId).text(clock);
        await timeline(dataInfo.match.matchId);
        affInfoLive(dataInfo);
        selPage(3);
    }
    function affInfoLive(data) {
        let nTry0 = 0, nTry1=0;
        try { nTry0 = data.teams[0].scoring.Try.length; } catch(e) {nTry0=0;}
        try { nTry1 = data.teams[1].scoring.Try.length; } catch(e) {nTry1=0;}
        let nPen0 = 0, nPen1=0;
        try { nPen0 = data.teams[0].scoring.Pen.length; } catch(e) {nPen0=0;}
        try { nPen1 = data.teams[1].scoring.Pen.length; } catch(e) {nPen1=0;}
        let nDG0 = 0, nDG1=0;
        try { nDG0 = data.teams[0].scoring.DG.length; } catch(e) {nDG0=0;}
        try { nDG1 = data.teams[1].scoring.DG.length; } catch(e) {nDG1=0;}

        let infoStr=data.match.eventPhase+': '+data.officials[0].official.name.display+' - '
            +data.match.teams[0].name+' ['+nTry0+']'+' ['+nPen0+']'+' ['+nDG0+']'
            +' / '
            +data.match.teams[1].name+' ['+nTry1+']'+' ['+nPen1+']'+' ['+nDG1+']'
            +'  ...        ([Try][Pen][Drop])'
        d3.select('#infoLive').text(infoStr);
    }
    function affLive() {
        clock=dataLive.match.clock.label;
        let mId = '#m'+dataLive.match.matchId;
        console.log(clock,mId,dataLive);
        d3.select(mId).text(clock);
		if (dataLive.match.status =='C') {
			idLive = 0;
			clearInterval(t);
		}
        let nTry0 = 0, nTry1=0;
        try { nTry0 = dataLive.teams[0].scoring.Con.length; }
        catch(e) {nTry0=0;}

        try { nTry1 = dataLive.teams[1].scoring.Con.length; }
        catch(e) {nTry1=0;}
        console.log(nTry0,nTry1);
        let e0Id = '#e0_'+dataLive.match.matchId, e1Id = '#e1_'+dataLive.match.matchId;
        d3.select(e0Id).text(dataLive.match.scores[0]);
        d3.select(e1Id).text(dataLive.match.scores[1]);
        let en0Id = '#en0_'+dataLive.match.matchId, en1Id = '#en1_'+dataLive.match.matchId;
        d3.select(en0Id).text(dataLive.match.teams[0].name+' ['+nTry0+']');
        d3.select(en1Id).text(dataLive.match.teams[1].name+' ['+nTry1+']');
        affInfoLive(dataLive);
		livePage();
    }
//--------------
// Get Data from url
//
	function getData(url, type) {
		//console.log(url);
		var opt = fetch(url, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',})})
		.then(response => { return response.json();})
		.then(data => {
		// JSON Data
			//console.log(data);
			switch (type) {
				case 1: listeMatchs = [];
						listeMatchs = data;
						dispatch.call('load');
						break;
				case 2: dataLive=[];
						dataLive = data;
						dispatch.call('live');
						break;
                case 3: dataInfo = data;
                        dispatch.call('match');
                        break;
                case 4: dataRank = data;
                        dispatch.call('rank');
                        break;
                case 5: dataTimeline=[];
						dataTimeline = data;
                        dispatch.call('timeline');
                        break;
                case 6: dataStandings=[];
                        dataStandings = data;
                        //console.log(dataStandings);
                        //dispatch.call('load');
                        break;
			}
		})
		.catch(err => {
		// Do something for an error here
			console.log(err);
		});
	}

  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     
     ga('create', 'UA-69988969-1', 'auto');
     ga('send', 'pageview');
  </script>
</body>
</html>