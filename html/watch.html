<!DOCTYPE html>
<title>WATCH 2.0</title>
<meta name="description" content="Get data a,d keep an eyes on ...">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>Pyrénées 2.0</title>
<style>
@import url(../css/new.css);
#menu {
    position : absolute;
    left: 75%;
    margin-top: 5px;
}
.rky header {
    position: fixed;
    top:0px;
    left:0px;
    width:100%;
    height: 50px;
    z-index: 0;
    background: #1e3F5E; /*#FE6F5E;/*#b0c4de; /*add8e6; /*f0f8FF;*/
  color: #fff;
  font-family: "helvetica neue", sans-serif;
}

.rky header aside{
    left:20px;
    width:100%;
    height: 20px;
  font-size: 11px;
  float: left;
  margin-right: 0.8em;
  padding-top: .2em;
  color: #fff;
}
.rky aside {
  font-size: 1.5vh;
  font-family: "helvetica neue", sans-serif;
  font-weight: 150;
  text-anchor: end;
  margin-right: 0.9vh;
    float: right;
/*    box-shadow: inset 5px 0 5px -5px #29627e;*/
}
#svg {
	display: block;
	margin: auto;
	opacity: 1;
/*	position : relative;*/
}
.rky h1 {
  font-family: "helvetica neue", sans-serif;
  font-size: 5vh;
  letter-spacing: 0.2vh;
  margin-left: 0px;
  margin-bottom: 0px;
  font-weight: 50;
  text-rendering: optimizeLegibility;
}
#h1 {
  font-size: 28px;
  font-weight: 250;
  letter-spacing: 2px;
  margin-left: 150px;
  margin-top: 5px;
  position: absolute;
  text-rendering: optimizeLegibility;
}
.rky footer aside{
    left:20px;
    width:50%;
    height: 20px;
  font-size: 11px;
  float: left;
  margin-right: 0.8em;
  padding-top: .2em;
  color: #fff;
}
.rky footer {
  position: fixed;
  bottom: 0px;
    left:0px;
    width:100%;
    height: 20px;
  font-size: 11px;
  float: left;
  margin-right: 0.8em;
  padding-top: .5em;
    background: #1e3F5E; /*#FE6F5E;/*#b0c4de; /*add8e6; /*f0f8FF;*/
}
.rky footer aside:after {
  padding-left: .5em;
  content: "|";
}
.rky footer {
  margin-top: 0.1em;
}
#date {
	left: 100px;
	color: 'red';
}
.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.horizontalGrid {
	fill : none;
	shape-rendering : crispEdges;
	stroke : lightgrey;
	stroke-width : 1px;
}
.verticalLine {
	fill : none;
	shape-rendering : crispEdges;
	stroke : lightgrey;
	stroke-width : 1px;
}
input#username,
input#password,
input#connexion { 
    border: 1px dotted #ccc;
    background: white;
    font-family: monospace;
    padding: 2% 2%;
    font-size: 18px;
    margin: 2% 2% 2% 5%;
    width : 85%;
    height: 40%;
    color: red;
}
input:focus { 
    background-color:#0cf; color: red; outline: none;
}
#credentials {
  left: 30%;
  top: 100px;
  margin: 10px;
  padding: 10px;
  width: 40%;
  position: absolute;
  border: 3px solid #ff7788;
}
#date {
	right:100px;
	width: 30%;
}
</style>
<header>
  <div id='h1'>Watch 2.0</div>
  <aside >April, 2021<br><br> | v 0.83</aside>
  <div id='menu'></div>
</header>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js" charset="utf-8"></script>
<body>
    <div id="chart"></div>
    <div id="histo"></div>
    <div id="credentials">
    <form name="saisie" onSubmit="return credClick()">
        <input type="text" id="username"><br>
        <input type="text" id="password">
<!--        <input name="Submit"  type="submit" id="connexion" value="Connexion" > -->
    </form></div>
  <footer>
  	<div>
      <aside>(c) e-Coucou | y2kL | Avril, 2021</aside>
      <aside id="date">time</aside>
    </div>
  </footer>
  <script type="text/javascript">
    var config = {credOK: false, tagOK:false, dataOK:false, arcOK:false, arbreOK: false};
    var urlBase = 'https://cors-rky.herokuapp.com/https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
	var urlBaseOld = 'https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
    var urlTime = '';
   	var interval = 'PT1M'  // PnYnMnD  TnHnMnS
    var urlRes = '&resolution='+interval;
    var url = '';
    /*
    let listeT1 = ['E-T15021','E-T15022','E-T15023','E-T15024','E-T15025','E-T15026','E-T15027','E-T15028','E-T15029','E-T15030','E-T15031','E-T15032']
    let listeT2 = ['E-T15041','E-T15042','E-T15043','E-T15044','E-T15045','E-T15046','E-T15047','E-T15048','E-T15049','E-T15050','E-T15051','E-T15052']
    let liste1 = ['E-T15099','E-TS19801','E-T19908','E-LX19901','E-TX19902','E-AO19991','E-F15154','E-PS15007','E-PS15011','E-PS15505','E-PS15605','E-AO19992','E-AO19993','E-AO19994'];
    let liste2 = ['E-PS15007','E-T15006','E-TC15002','E-TC15005','E-TY15004','E-T15401'];
    */
    let liste3 = []; //['E-F15154','E-FC15167','E-P15104','E-P16151','E-PO16151','E-T15106','E-TC15103'];
    let pathData = [{source:'E-FCS14325',cible:'E-TC17601',color:'blue', i:0,o:0,e:3,anim:'E-FCV14325'},
    				{source:'E-FCS12085',cible:'E-TC17601',color:'black', i:0,o:0,e:5,anim:'E-CV12086A'},
    				{source:'E-FC16325',cible:'E-TC17601',color:'red', i:0,o:0,e:2,anim:'E-CV16325A'},
    				{source:'E-FC12001',cible:'E-CV12086A',color:'black', i:0,o:0,e:5,anim:'E-CV12086A'},
    				{source:'E-CV12086A',cible:'E-FCS12085',color:'black', i:0,o:0,e:6,anim:'E-CV12086A'},
    				{source:'E-FS31053',cible:'E-CV12086A',color:'grey', i:0,o:0,e:2,anim:'E-CV12086A'},
    				{source:'E-TC17601',cible:'E-CV18167',color:'green', i:0,o:0,e:5,anim:'E-CV18167'},
    				{source:'E-TC17601',cible:'E-CV15167A',color:'green', i:0,o:0,e:3,anim:'E-CV15167A'},
                    {source:'E-TC17601',cible:'E-CV15167B',color:'green', i:0,o:0,e:2,anim:'E-CV15167B'},
    				{source:'E-CV15167A',cible:'E-FC15167',color:'green', i:0,o:0,e:3,anim:'E-CV15167A'},
                    {source:'E-CV15167B',cible:'E-FC15167',color:'green', i:0,o:0,e:2,anim:'E-CV15167B'},
                    {source:'E-CV18167',cible:'E-F18161',color:'green', i:0,o:0,e:5,anim:'E-CV18167'},
    				{source:'E-FC15167',cible:'Pyrénées',color:'green', i:0,o:1,e:4,anim:'E-CV15167A'},
    				{source:'E-F18161',cible:'Europe 2',color:'green', i:0,o:1,e:5,anim:'E-CV18167'},
    				{source:'E-FCV14325',cible:'E-FCS14325',color:'blue', i:0,o:0,e:3,anim:'E-FCV14325'},
    				{source:'E-CV16325A',cible:'E-FC16325',color:'red', i:0,o:0,e:1,anim:'E-CV16325A'},
    				{source:'E-CV16325B',cible:'E-FC16325',color:'red', i:0,o:0,e:1,anim:'E-CV16325B'},
                    {source:'Pyrénées',cible:'E15100',color:'yellow', i:1,o:0,e:4,anim:'E-CV15167A'},
                    {source:'Europe 2',cible:'E18100',color:'yellow', i:1,o:0,e:5,anim:'E-CV18167'},
                    {source:'E15100',cible:'E-TC15202',color:'yellow', i:0,o:0,e:4,anim:'E-CV15167A'},
                    {source:'E18100',cible:'E-TC18202',color:'yellow', i:0,o:0,e:5,anim:'E-CV18167'}
    				];
    let itemData = [];
	// Chart dimensions.
	var margin = {top: 20, right: 20, bottom: 30, left: 50},
    	width = window.innerWidth; // - margin.right-margin.left,
    	height = window.innerHeight; // - margin.top - margin.bottom;
	var couleur = ['grey','green','violet','cyan','blue','orange','yellow','red'],
	    nbCouleur = couleur.length;

	var dashData=[],histData=[]; username='Username', password='Password';
    var histList = ['E-TC15002'];
	// Create the SVG container and set the origin.
	const svg = d3.select('#chart').append("svg")
    	.attr("id", "svg")
    	.attr("width", (width))
    	.attr("height", (height));
	const svgHisto = d3.select('#histo').append("svg")
    	.attr("id", "svgHisto")//.attr("position", 1)
    	.attr("width", (width/2))
    	.attr("height", (height/2));
//    	.append('g').attr('transform','translate('+0+','+(height/2.0)+')').raise();
	var dispatch = d3.dispatch('histo');
    dispatch.on('histo',aff_histo);
    var t_cycle = setInterval(refreshData,60000);
// menu
const data_menu = [
        { n:0, x:-280, m:'trophy', a: 168 , val: '',http:'/RWC-2019.html'},  //th
        { n:1, x:-280, m:'trophy', a: 48 , val: '',http:'/RWC-2019.html'},  //th
        { n:2, x:-280, m:'trophy', a: 24 , val: '',http:'/RWC-2019.html'},  //th
        { n:3, x:-280, m:'trophy', a: 12 , val: '',http:'/RWC-2019.html'},  //th
        { n:4, x:-280, m:'trophy', a: 6 , val: '',http:'/RWC-2019.html'},  //th
        { n:5, x:-280, m:'trophy', a: 2 , val: '',http:'/RWC-2019.html'},  //th
    ];
var svgMenu = d3.select("#menu").append("svg")
    .attr('width',45*data_menu.length).attr('height',40);
var menuG = svgMenu.selectAll('g').data(data_menu).enter()
        .append('g')
        .attr('transform',(d,i)=>{return 'translate('+(i*40+20)+',10)';})
        .on('click',clickMenu);
let selGraphe = 1;
var menuCircle=false, histTime = 48;
    menuG.append('rect').style('fill',(d,i)=>(d.n==selGraphe)?'#B233FF':'#4C33FF').attr('id','menuRect')
        .attr('r',17).attr('width',38).attr('height',39).attr('x',-8).attr('y',-9)
        .on('mouseover',function(d) {d3.select(this).style('fill','#33CAFF')})
        .on('mouseout',function(d){d3.select(this).style('fill',(d,i)=>(d.n==selGraphe)?'#B233FF':'#4C33FF')});
    if (menuCircle) {
        menuG.append('circle').style('fill',(d,i)=>(d.n==selGraphe)?'red':'#FE6FcE')
            .attr('r',17).attr('cx',(d,i)=>{return 10;}).attr('cy',10);
    }
function clickMenu (d) {
    console.log(d);
    histTime = d.a; selGraphe = d.n;
    switch (d.n) {
        case 0 : refreshData(); break;
    }
    getHistorique(histList[0]);
}
//credentials ...
	let code =btoa(username+':'+password);
	cred();
//---------------
// get Data
function getValeur() {
    let refDashboard='';
    let now = new Date(Date.now());
    let end = new Date(Date.now());
//    let offset = now.getTimezoneOffset();
//    let hour = now.getHours()+offset/60;
//	now.setHours(hour);
	now.setMinutes(now.getMinutes()-11);
//	console.log('heure',now,end);
    urlTime = '&from='+encodeURIComponent(now.toISOString())+'&to='+encodeURIComponent(end.toISOString());
//    console.log(urlTime);
    url = urlBase+encodeURIComponent('E-T15099')+urlTime+'&resolution=PT1H';
    getDashData(url,'coucou','#info');
//    getValeurListe(urlTime,listeT1);
//    getValeurListe(urlTime,listeT2);
//    getValeurListe(urlTime,liste1);
//    getValeurListe(urlTime,liste2);
    getValeurListe(urlTime,liste3);
    getHistorique(histList[0]);
}
function getValeurListe(urlTime,liste) {
	liste.forEach( tag => {
		url = urlBase+encodeURIComponent(tag)+urlTime+'&resolution=PT1H';
		getDashData(url,tag,'#'+tag);
	});
}
function getHistorique(d) {
//	console.log(d);
    histList[0] = d;
    let now = new Date(Date.now());
    let end = new Date(Date.now());
//    let offset = now.getTimezoneOffset();
//    let hour = now.getHours()+offset/60;
//	now.setHours(hour);
	now.setHours(now.getHours()- histTime);
	end.setHours(end.getHours()+0.1);
//	console.log('heure',now,end);
    urlTime = '&from='+encodeURIComponent(now.toISOString())+'&to='+encodeURIComponent(end.toISOString());
//    console.log(urlTime);
	url = urlBase+encodeURIComponent(d)+urlTime+'&resolution=PT1M'; // PnYnMnD  TnHnMnS
//	console.log(urlTime,url);
	getHistData(url,d,'#'+d);
//	console.log('data read ?');
}
//----------------------------------------------------------------------------------------
//- lecture du dashboard ...
//----------------------------------------

function getDashData (urldata,index,id) {
    var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
        'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
        return response.json();
        })
    .then(data => { 
            dashData[index]=data;
            let value = data[0].values[0].value, unit = data[0].unit;
//            console.log(id,value);
            if (value != null) {
                d3.selectAll(id).text(valFormat(value)+' '+data[0].unit);
                d3.selectAll(id+'_r').style('stroke','#00f');
                d3.selectAll('#date').text('| '+i_c(data[0].values[0].timestamp));
                update_level(id,value,unit,true);
                update_vanne(id,value,unit,true);
            }
            d3.selectAll(id+'_c').style('fill','#0f0');
//            dispatch.call('histo');
        })
    .catch(err => {
//        infoG.select('text').text("ERREUR : "+err);
//        infoG.select('circle').attr('fill','black');
//        config.dataOK=false;
		dashData[index]=[{values:[{timestamp:0,value:-1}],unit:' xxx'}];
        d3.selectAll(id).text(valFormat(-1)+' '+'xxx');
      console.log(err);
    })   
}
//--------------------------
//- Lecture de l'historique
//
function getHistData(urldata,index,id) {
    var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
        'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
        return response.json();
        })
    .then(data => { 
        histData = data;
//            console.log(data);
//            aff_histo();
            dispatch.call('histo');
        })
    .catch(err => {
      console.log(err);
    })   
}

let valFormat = (a) => { 
        let r = (a>1000) ? Math.round(a) : ( (a>10)? Math.round(a*10.0)/10 : Math.round(a*100.0)/100);
        return String(r).replace(/(.)(?=(\d{3})+$)/g,'$1 ');
}
var format = d3.timeFormat("%H:%M:%S");
    function i_c(d) { 
    	return format( new Date(d));
    }
//----------------------------------------------------------------
// CREDENTIALS
//
function cred() {
    svg.attr("viewBox", "0 0 "+(width )+" "+(height))
    let connexion = svg.append('g').selectAll('g').data([0]).enter().append('g')
                        .attr('transform', (d,i)=> {return 'translate('+(0.25*width)+','+(0.6*height)+')';})
                        .on('click',get_connexion)
                        .on('mouseover',(d,i)=> {
                            d3.selectAll('#rect_connexion').style('fill','red')  })
                        .on('mouseout',(d)=> {
                            d3.selectAll('#rect_connexion').style('fill','#77C')  });

        connexion.append('rect').attr('rx',2).attr('ry',2).attr('id','rect_connexion')
            .attr('width',(0.5*width)).attr('height',(0.1*height)).style('fill', '#77C'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
        connexion.append('text').attr('x',(0.25*width)) //.attr('y',10)
            .attr('y',(0.07*height)).attr('id','connexion') //.attr('id',(d)=>{return ('en0_'+d.matchId);})
//            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'#ccc';})
            .style('text-anchor', 'middle').style('fill','white')
            .style('font-weight', 'bold').style('dominant-baseline','middle')
            .text('Connexion').style('font-size','4vw');
    var credential = [
                {name: 'username', type: 'text', display: 'Username'},
                {name: 'password', type: 'text', display: 'Password'},
                {name: 'submit', type: 'submit', display: 'Username'}
            ];
    let size={l:200,h:200};
/*    let credG = graph.append('g')
        .append('foreignObject').attr('x',10).attr('y',10).attr('width',300).attr('height',150);
    credG.append('rect').attr('x',width/2-size.l/2+margin.left).attr('y',80)
        .attr('width',size.l).attr('height',size.h).style('fill','#BCD4E6');
		*/
        d3.select('#credentials').attr('width',300).style('display','inline').raise();
        d3.select('#username').attr('placeholder',username).on('change',credClick);
        d3.select('#password').attr('placeholder',password).on('change',credClick);
}

function credClick() {
    let val = d3.select('#username').property('value');
    if (val!='') username=val;
    val = d3.select('#password').property('value');
    if (val!='') password=val;
    code =btoa(username+':'+password);
	if (username!='Username' && password != 'Password') {
		config.credOK=true;
	} else {
		console.log('saisie credential');
    }
//	d3.select('#connexion').style('background',"yellow");
//	console.log(code);
    return false;
}
function get_connexion() {
	console.log('Code sécurisé de connexion :',code);
	clearSVG();
	affiche_trame();
/*	aff_valeur();
	aff_liste_T(listeT1,0.01*width);
	aff_liste_T(listeT2,0.81*width);
	aff_liste_T(liste1,0.20*width);
	aff_liste_T(liste2,0.39*width);
*/	aff_liste_T(liste3,0.9*width);
	
	getValeur();
}
var shape = { cuveV : 'M 0,0 L 1,0 M 0,0 L 0,1 Q 3,-1 6,1 L 6,12 Q 3,14 0,12 Z', cuveH : 'M 0,0 L 1,0 M 0,0 L 0,1 M 5,0 L 35,0 Q 40,8 35,16 L 5,16 Q 0,8 5,0 Z' }
function affiche_trame() {
	//intervalles largeur / hauteur
	let w_i = (width/2/8) ; h_i = height/2/15;
    let init_w = width/6;
	let alim = {x:w_i*0.2, y:60, e: 4};
	with (alim) {
//		const {h,l} = shape_cuve(x,y,e,'R19900',shape.cuveH,1)
//		shape_level(x+l-5*7,y,7,h,15,'E-LX19901',50,false);
//off gaz
		y1 = shape_temp(x,y,e,3,8,'E-FS31053',50,false);
		y1 = shape_temp(x,y1,e,3,8,'E-PS31052',50,false);
		y1 = shape_temp(x,y1,e,3,8,'E-TS31051',50,false) + h_i;
		y2 = shape_temp(x,y1,e,3,8,'E-FC12001',50,false);
// compresseur
		x += w_i;
		y2 = shape_vanne(x,y1,e,3,8,'E-CV12086A',50,false)+10;
		y2 = shape_temp(x,y2,e,3,8,'E-I12000',50,false);
		y2 = shape_temp(x,y2,e,3,8,'E-TY12008',50,false);
		y2 = shape_vanne(x,y2,e,3,8,'E-CV12086B',50,false);
//debit d'air
		x += w_i; y2=y1;
		y1 = shape_temp(x,y1,e,3,8,'E-FCS12085',50,false);
//débit Eau
		y3 = shape_vanne(x-w_i,y1+70,e,3,8,'E-FCV14325',50,false);
		y1 = shape_temp(x,y1+70,e,3,8,'E-FCS14325',50,false);
//débit C3
		y3 = shape_vanne(x-w_i,y1+20,e,3,8,'E-CV16325A',50,false);
		y3 = shape_vanne(x-w_i,y1+40,e,3,8,'E-CV16325B',50,false);
		y1 = shape_temp(x,y1+30,e,3,8,'E-FC16325',50,false);
//réchauffeur
		x += w_i*1.5; y1=y2;
		y2 = shape_temp(x,y1,e,3,8,'E-TC17601',50,false);
// ouverture
        x += w_i;
        y2 = shape_vanne(x,y1-20,e,1,2,'E-CV18167',50,false) +30;
        y2 = shape_vanne(x,y2,e,1,2,'E-CV15167A',50,false);
        y2 = shape_vanne(x,y2,e,1,2,'E-CV15167B',50,false);
//débits
		x += w_i;
		y2 = shape_temp(x,y1-20,e,3,8,'E-F18161',50,false) +30;
		y2 = shape_temp(x,y2,e,3,8,'E-FC15167',50,false);
		y2 = shape_temp(x,y2,e,3,8,'E-F15161',50,false);
		y2 = shape_temp(x,y2,e,3,8,'E-PY15071',50,false);
		y2 = shape_temp(x,y1-42,e,3,8,'E-PY18071',50,false);
	}

	// réacteur K15000
	let K15000 = {x:(width*0.63), y:(height/2+20), e: 15, xl:0};
	with (K15000) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'Pyrénées',shape.cuveV,1); xl = x+l;y1 = y+ h/8; x += 3;
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T15008',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-P15162',50,false);
//		y1 = shape_temp(x,y1,e,e/3,e/2,'E-P15071',50,false);
        shape_temp(x+0.6*l,y1,e,e/3,e/2,'ROC_PY_Temp_Pt_Chaud_Max_Sonde1',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-PD15010',50,false)+h/15;
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T15021',50,false);y2=y1;
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T15024',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T15028',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T15032',50,false);
		y1 = shape_temp(x+l+20,y+h+5,e,e/3,e/2,'E-TY15012',50,false);
		y1 = shape_temp(x+l/2,y+h+5,e,e/3,e/2,'E-TC15019',50,false);
		y2 = shape_temp(x+3*l/4,y2,e,e/3,e/2,'E-T15006',50,false);
		y2 = shape_temp(x+3*l/4,y2,e,e/3,e/2,'E-TC15005',50,false);
		y2 = shape_temp(x+l,y2,e,e/3,e/2,'E-T15099',50,false);
		y2 = shape_temp(x+l-l/7,y,e,e/3,e/2,'E-PS15007',50,false);
        y2 = shape_temp(x+l-l/7,y2,e,e/3,e/2,'E-TC15002',50,false);
	}
	// réacteur K18000
	let K18000 = {x:(width*0.63), y:(60), e: 15, xl: 0};
	with (K18000) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'Europe 2',shape.cuveV,1); xl = x+l; y1 = y+ h/8; x += 3;
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T18008',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-P18162',50,false);
//		y1 = shape_temp(x,y1,e,e/3,e/2,'E-PC18071',50,false);
        shape_temp(x+0.6*l,y1,e,e/3,e/2,'ROC_E2_Temp_Pt_Chaud_Max_Sonde1',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-PD18010',50,false)+h/15;
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T18021',50,false);y2=y1;
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T18024',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T18028',50,false);
		y1 = shape_temp(x,y1,e,e/3,e/2,'E-T18032',50,false);
		y1 = shape_temp(x+l+20,y+h+5,e,e/3,e/2,'E-TY18012',50,false);
		y1 = shape_temp(x+l/2,y+h+5,e,e/3,e/2,'E-TC18019',50,false);
		y2 = shape_temp(x+3*l/4,y2,e,e/3,e/2,'E-T18006',50,false);
		y2 = shape_temp(x+3*l/4,y2,e,e/3,e/2,'E-TC18005',50,false);
		y2 = shape_temp(x+l,y2,e,e/3,e/2,'E-T18099',50,false);
		y2 = shape_temp(x+l-l/7,y,e,e/3,e/2,'E-PS18007',50,false);
        y2 = shape_temp(x+l-l/7,y2,e,e/3,e/2,'E-TC18002',50,false);
	}
// bache à sel Py
	let R19900 = {x:(width*0.48), y:(height*0.72), e: 4};
	with (R19900) {
		const {h,l} = shape_cuve(x,y,e,'R19900',shape.cuveH,1)
		shape_level(x+l-5*7,y,7,h,15,'E-LX19901',50,false);
		shape_temp(x+20,y,5,3,8,'E-T19908',50,false);
		shape_temp(x+20,y+20,5,3,8,'E-TS19801',50,false);
		shape_temp(x+20,y+40,5,3,8,'E-TX19902',50,false);
		shape_temp(x,y-100,5,3,8,'E-AO19993',50,false);
		shape_temp(x,y-80,5,3,8,'E-AO19994',50,false);
		shape_temp(x,y-60,5,3,8,'E-AO19991',50,false);
		shape_temp(x,y-40,5,3,8,'E-AO19992',50,false);
	}
// bache à sel E2
	let R19000 = {x:(width*0.48), y:(height*0.22+50), e: 4};
	with (R19000) {
		const {h,l} = shape_cuve(x,y,e,'R19000',shape.cuveH,1)
		shape_level(x+l-5*7,y,7,h,15,'E-LX19001',50,false);
		shape_temp(x+20,y,5,3,8,'E-T19008',50,false);
		shape_temp(x+20,y+20,5,3,8,'E-TS19001',50,false);
		shape_temp(x+20,y+40,5,3,8,'E-TX19002',50,false);
//		shape_temp(x-50,y,5,3,8,'E-AO19993',50,false);
//		shape_temp(x-50,y+20,5,3,8,'E-AO19994',50,false);
//		shape_temp(x-50,y+40,5,3,8,'E-AO19991',50,false);
//		shape_temp(x-50,y+60,5,3,8,'E-AO19992',50,false);
	}	// rechauffeur Electrique
	let E15400 = {x:(K15000.x-80), y:(K15000.y), e: 10};
	with (E15400) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E15400',shape.cuveV,0.8); y += 12; x += 3;// console.log('size : ',h,l)
		y = shape_temp(x,y,e,0,0,'E-T15408',50,false);
		y = shape_temp(x,y,e,0,0,'E-J15406',50,false);
		y = shape_temp(x,y,e,3,e,'E-TS15409',50,false);
		y = shape_temp(x,y,e,3,e,'E-TDX15407',50,false);
	}
	// rechauffeur Electrique
	let E18400 = {x:(K18000.x-80), y:(K18000.y), e: 10};
	with (E18400) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E18400',shape.cuveV,0.8); y += 12; x += 3;// console.log('size : ',h,l)
		y = shape_temp(x,y,e,0,0,'E-T18408',50,false);
		y = shape_temp(x,y,e,0,0,'E-J18406',50,false);
		y = shape_temp(x,y,e,3,e,'E-TS18409',50,false);
		y = shape_temp(x,y,e,3,e,'E-TDX18407',50,false);
	}
	// GV 40
	let E15500 = {x:(width * 7/9), y:(K15000.y), e: 11};
	with (E15500) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E15500',shape.cuveV,0.7); y += 12, x += 3;
		shape_level(x+l-15,y,e,h-e*2,10,'E-LC15504',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-PC15506',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-LS15503',50,false);
	}
	// GV 10
	let E15600 = {x:(width*5/6), y:(K15000.y+90), e: 11};
	with (E15600) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E15600',shape.cuveV,0.7); y += 12, x += 3;
		shape_level(x+l-15,y,e,h-e*2,10,'E-LC15604',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-PC15606',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-LS15603',50,false);
	}
	// GV 40
	let E18500 = {x:(width*7/9), y:K18000.y, e: 11};
	with (E18500) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E18500',shape.cuveV,0.7); y += 12, x += 3;
		shape_level(x+l-15,y,e,h-e*2,10,'E-LC18504',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-PC18506',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-LS18503',50,false);
	}
	// GV 10
	let E18600 = {x:(width*5/6), y:(K18000.y+90), e: 11};
	with (E18600) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E18600',shape.cuveV,0.7); y += 12, x += 3;
		shape_level(x+l-15,y,e,h-e*2,10,'E-LC18604',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-PC18606',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-LS18603',50,false);
	}
	// Condenseur
	let E15100 = {x:(K15000.x*1.1), y:(K15000.y+235), e: 2};
	with (E15100) {
		const {h,l} = shape_cuve(x,y,e,'E15100',shape.cuveH,1)
		shape_temp(x+l/4,y+h/4,5,3,8,'E-T15101',50,false);
		shape_temp(x+l,y-h/4,5,3,8,'E-P15104',50,false);
		shape_temp(x+l*3,y+h/2,5,3,8,'E-TC15202',50,false);
	}
	let E18100 = {x:(K18000.x*1.1), y:(K18000.y+235), e: 2};
	with (E18100) {
		const {h,l} = shape_cuve(x,y,e,'E18100',shape.cuveH,1)
		shape_temp(x+l/4,y+h/4,5,3,8,'E-T18101',50,false);
		shape_temp(x+l,y-h/4,5,3,8,'E-P18104',50,false);
        shape_temp(x+l*3,y+h/2,5,3,8,'E-TC18202',50,false);
	}
	let E15300 = {x:(width*0.74), y:(K15000.y+height/8.7), e: 2};
	with (E15300) {
		shape_level(x-w_i/8,y-27,e,24,6,'E-LS15301',50,false);
		shape_level(x+w_i/8,y-27,e,24,6,'E-LS15302',50,false);
		shape_motor(x,y-35,e,10,2,'E-JY15306',50,false);
		y1=shape_temp(x-w_i/4,y,5,3,8,'E-T15307',50,false);
		y1=shape_temp(x-w_i/4,y1,5,3,8,'E-T15308',50,false);
//		shape_temp(x+20,y+40,5,3,8,'E-TC15102',50,false);
	}
	let E15700 = {x:(width*0.79), y:(K15000.y+height/4.7), e: 2};
	with (E15700) {
		shape_level(x-w_i/8,y-27,e,24,6,'E-LS15701',50,false);
//		shape_level(x+w_i/2,y-35,e,24,6,'E-LS15302',50,false);
		shape_motor(x,y-35,e,10,2,'E-JY15706',50,false);
		y1=shape_temp(x-w_i/4,y,5,3,8,'E-T15707',50,false);
		y1=shape_temp(x-w_i/4,y1,5,3,8,'E-T15708',50,false);
	}
	let E18300 = {x:(width*0.74), y:(K18000.y+height/8.7), e: 2};
	with (E18300) {
		shape_level(x-w_i/8,y-27,e,24,6,'E-LS18301',50,false);
		shape_level(x+w_i/8,y-27,e,24,6,'E-LS18302',50,false);
		shape_motor(x,y-35,e,10,2,'E-JY18306',50,false);
		y1=shape_temp(x-w_i/4,y,5,3,8,'E-T18307',50,false);
		y1=shape_temp(x-w_i/4,y1,5,3,8,'E-T18308',50,false);
//		shape_temp(x+20,y+40,5,3,8,'E-TC15102',50,false);
	}
	let E18700 = {x:(width*0.79), y:(K18000.y+height/4.7), e: 2};
	with (E18700) {
		shape_level(x-w_i/8,y-27,e,24,6,'E-LS18701',50,false);
//		shape_level(x+w_i/2,y-35,e,24,6,'E-LS15302',50,false);
		shape_motor(x,y-35,e,10,2,'E-JY18706',50,false);
		y1=shape_temp(x-w_i/4,y,5,3,8,'E-T18707',50,false);
		y1=shape_temp(x-w_i/4,y1,5,3,8,'E-T18708',50,false);
	}

}
function refresh() {
	d3.selectAll('circle').style('fill','black');
	d3.selectAll('rect').style('stroke','black');
	getValeur();
}
function refreshData() {
    refresh();
}
//-----------------------
//
function shape_cuve (x,y,ech,id,forme,rot) {
	let shape= svg.append('g').selectAll('g').data([0]).enter().append('g')
					.attr('transform','translate('+x+','+(y)+') scale('+ech+','+(ech*rot)+')'); // rotate('+rot+')');
		shape.append('path').attr('d', forme).style('stroke-width',1/ech).style('stroke','#666').style('fill','#EEE').attr('id',id+'_p');
	let rect = document.getElementById(id+'_p').getBoundingClientRect();
	let h = rect.height;
	let l = rect.width;
		shape.append('text').text(id).raise()
			.attr('x',(0.5*l/ech)).attr('y',(0.5*h/ech/7))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',10/ech)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");
        itemData[id] = {x:x,y:y,h:h,l:l};
 	return {h: h, l: l};
}
function shape_level (x,y,ech,h,l,id,val,status) {
	liste3.push(id);// ech = 5;// h= ech *10; l=2*ech;
	let level = svg.append('g').selectAll('g').data([id]).enter().append('g')
					.attr('transform','translate('+x+','+y+')').raise()
					.on('click',getHistorique); // scale('+ech+')').raise();
		level.append('rect').attr('width',l).attr('height',h).attr('x',1).attr('y',1).style('stroke-width',1)
			 .style('stroke','#666').style('fill','#fff').attr('id',id+'_s');
		level.append('rect').attr('width',(l-2)).attr('x',2).attr('y',(h*(100-val)/100)+1).attr('height',(h*val/100)).raise()
			.attr('id',id+'_val')
			.style('stroke-width',1).style('stroke','#666').style('fill',status?'#00b':'#ccc');
		level.append('text').text(val).attr('id',id+'_txt').raise()
			.attr('x',(0.7*l)).attr('y',(0.5*h))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.5*5)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");
        itemData[id] = {x:x,y:y,h:h,l:l};
		return;
}
function shape_motor (x,y,ech,h,l,id,val,status) {
	liste3.push(id);// 
	h= ech ;
	let vanne = svg.append('g').selectAll('g').data([id]).enter().append('g')
					.attr('transform','translate('+(x+h)+','+(y+h)+')').raise()
					.on('click',getHistorique); // scale('+ech+')').raise();
//		vanne.append('rect').attr('width',l).attr('height',h).attr('x',1).attr('y',ech*2).style('stroke-width',1)
//			 .style('stroke','#666').style('fill','#fff').attr('id',id+'_v');
		vanne.append('circle').attr('r',1).raise()
			.attr('id',id+'_val')
			.style('stroke-width',1).style('stroke','#666').style('fill',status?'#00b':'#ccc');
		vanne.append('text').text(val).attr('id',id+'_txt').raise()
			.attr('x',(0.5*l)).attr('y',(0.5*h*2))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.5*5)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");

        itemData[id] = {x:x,y:y,h:ech*4,l:l};
		return (y+h*4);
}
function shape_vanne (x,y,ech,h,l,id,val,status) {
	liste3.push(id);// 
	h= ech ; l=10.2*ech;
	let vanne = svg.append('g').selectAll('g').data([id]).enter().append('g')
					.attr('transform','translate('+x+','+y+')').raise()
					.on('click',getHistorique); // scale('+ech+')').raise();
		vanne.append('rect').attr('width',l).attr('height',h).attr('x',1).attr('y',ech*2).style('stroke-width',1)
			 .style('stroke','#666').style('fill','#fff').attr('id',id+'_v');
		vanne.append('rect').attr('height',(h)).attr('y',ech*2).attr('x',1).attr('width',(l*val/100)).raise()
			.attr('id',id+'_val')
			.style('stroke-width',1).style('stroke','#666').style('fill',status?'#00b':'#ccc');
		vanne.append('text').text(val).attr('id',id+'_txt').raise()
			.attr('x',(0.5*l)).attr('y',(0.5*h*2))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.5*5)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");

        itemData[id] = {x:x,y:y,h:ech*4,l:l};
		return (y+h*4);
}
function shape_temp (x,y,ech,h,l,id,val,status) {
	liste3.push(id); ech = 5; h= ech *3.9; l=10.2*ech;
	let temp = svg.append('g').selectAll('g').data([id]).enter().append('g')
					.attr('transform','translate('+x+','+y+')').raise()
					.on('click',getHistorique)
					.on('mouseover',(d) => {
                            d3.selectAll('#'+d+'_r').style('fill','red');  })
					.on('mouseout',(d) => {
                            d3.selectAll('#'+d+'_r').style('fill','white');  }); // scale('+ech+')').raise();
		temp.append('rect').attr('width',l).attr('height',h).attr('x',0).attr('y',0).style('stroke-width',1).style('stroke','#666').style('fill','#fff').style('rx',1).style('ry',1).attr('id',id+'_r');
		temp.append('text').text(val).attr('id',id+'_txt')
			.attr('x',(0.52*l)).attr('y',(0.8*h))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.7*ech)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");
        if (id.length>15) {id='PtChaud';}
		temp.append('text') // no id
			.attr('x',(0.52*l)).attr('y',(0.4*h))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.7*ech)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue")
            .text(id);
//        temp.append('circle').attr('r',1).attr('cx',1).attr('cy',1).style('fill','red').attr('id',id+'_c');
        itemData[id] = {x:x,y:y,h:h,l:l};
		return (y+h*1.1);
}
function path_item () {
	let lineP = d3.line()
    	.x((d) => { return d.x;})
    	.y((d) => { return d.y;})
        .curve(d3.curveMonotoneX);

    let data2=[], data3 = [];
    pathData.forEach((a)=>{
//    	console.log(a);
    	data2=[];
        let x1 = (itemData[a.source].x + itemData[a.source].l * (a.i==0?1:0.5) ), 
            y1 = (itemData[a.source].y + itemData[a.source].h * (a.i==0?0.5:1));
        let x2 = (itemData[a.cible].x  + itemData[a.cible].l  * (a.o==0?0.0:0.5) ),
            y2 = (itemData[a.cible].y  + itemData[a.cible].h  * (a.o==0?0.5:0));
//        let x1 = (itemData[a.source].x + itemData[a.source].l), y1 = (itemData[a.source].y+(itemData[a.source].l==0?0:0.5)*itemData[a.source].h);
//        let x2 = (itemData[a.cible].x), y2 = (itemData[a.cible].y+(itemData[a.cible].l==0?0:0.5)*itemData[a.cible].h);
    	data2.push({x:x1,y:y1});
        data2.push({x:x1+(a.i==0?3:0),y:y1+(a.i==0?0:5)});
        if (a.o==1) {
            let x3 = x1 + (x2-x1) /3 , y3 = y1 + 2*(y2-y1)/3;
            data2.push({x:x3,y:y3});
        }
        let color = '#777', stroke = 1;
//        console.log(a.anim, dashData[a.anim][0]);
        if (dashData[a.anim][0].values[0].value>0.1)
            { color = a.color, stroke = a.e ;
            }
        data2.push({x:x2-(a.o==0?3:0),y:y2-(a.o==0?0:5)});
    	data2.push({x:x2, y:y2});
    	data3.push({values:data2,color:color, stroke:stroke});
    });
//    let data3 = [{values:data2}];

//  console.log('PATH',data3);
	d3.select('#flow').remove();
	let path = svg.append('g').attr('id','flow').attr("fill", "none").attr("stroke", "currentColor")
	.selectAll('path').data(data3).enter()
	.append('path')
		.attr('class','g_line')
    	.attr("d", d => { return lineP(d.values);})
        .style("stroke", d=>d.color).style("stroke-width", d=>d.stroke);
}
function update_level(id,val,unit,status){ //console.log('rect_s',id);
	try {
        if (unit == "Ø") { val = val *100; unit = "%"}
		let h = d3.select(id+'_s').node().getBoundingClientRect().height; 
		d3.selectAll(id+'_val').attr('y',(h*(100-val)/100)+1).attr('height',(h*val/100)).style('fill',status?'#0e0':'black');
	} catch (error) {
	  // not level
	}
	d3.selectAll(id+'_txt').text(valFormat(val)+' '+unit);
}
function update_vanne(id,val,unit,status){ //console.log('rect_s',id);
	try {
        if (unit == "Ø") { val = val *100; unit = "%"}
		let l = d3.select(id+'_v').node().getBoundingClientRect().width; 
		d3.selectAll(id+'_val').attr('x',1).attr('width',(l*val/100)).style('fill',status?'#0e0':'black');
	} catch (error) {
	  // not level
	}
	d3.selectAll(id+'_txt').text(valFormat(val)+' '+unit);
}
function aff_valeur() {
	//on affiche
//	console.log(width,height);
	let h_g= height-50-20;
    let liste = svg.append('g').selectAll('g').data(['E-T15099','futur']).enter().append('g')
                        .attr('transform', (d,i)=> {return 'translate('+(0.20*width)+','+(0.01*h_g+50 +i*h_g/2)+')';})
                        .on('click',refresh)
                        .on('mouseover',(d,i)=> {
                            d3.selectAll('#rect_refresh'+i).style('fill','red');
                              })
                        .on('mouseout',(d,i)=> {
                            d3.selectAll('#rect_refresh'+i).style('fill','#337')  });

        liste.append('rect').style('rx',5).style('ry',5).attr('id',(d,i)=>{return 'rect_refresh'+i; })
            .attr('width',(width*0.6)).attr('height',(0.47*h_g)).style('fill', '#337'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
        liste.append('text').attr('x',(0.3*width)) //.attr('y',10)
            .attr('y',(0.27*h_g)).attr('id','info') //.attr('id',(d)=>{return ('en0_'+d.matchId);})
//            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'#ccc';})
            .style('text-anchor', 'middle').style('fill','white')
            .style('font-weight', 'bold').style('dominant-baseline','middle')
            .text('val').style('font-size','13vw')
            .on('mouseover',d=>{d3.select('#info').text(d)})
            .on('mouseout',d=>{d3.select('#info').text(valFormat(dashData['coucou'][0].values[0].value)+' '+dashData['coucou'][0].unit)});
}
//--------------
// on affiche les listes de valeur sur le coté ...
function aff_liste_T(liste,decalage) {
	let h_g= height-65;
	let inc = Math.round(0.97*h_g/(liste.length/2));
	let w = 0.03; decalage = (1-(w+0.0)*2)*width;
    let liste_T = svg.append('g').selectAll('g').data(liste).enter().append('g')
                        .attr('transform', (d,i)=> 
                            {return 'translate('+(decalage+(Math.round(i/liste.length)* (w * width +2)))+','+(51+ (i%(liste.length/2))*inc)+')';})
                        .on('click',refresh)
                        .on('mouseover',(d,i)=> {
                            d3.selectAll('#rect_refresh'+d).style('fill','red');
                            d3.selectAll('#'+d+'_r').style('fill','red');  })
                        .on('mouseout',(d,i)=> {
                            d3.selectAll('#rect_refresh'+d).style('fill','#1e3F5E');
                            d3.selectAll('#'+d+'_r').style('fill','white');  });

        liste_T.append('rect').attr('rx',1).attr('ry',1).attr('id',(d,i) => { return 'rect_refresh'+d; })
            .attr('width',(w*width)).attr('height',(inc-2)).style('fill', '#1e3F5E'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
        liste_T.append('text').attr('x',(w/2*width)) //.attr('y',10)
            .attr('y',(inc/2+1)).attr('id',d=>{return d}) //.attr('id',(d)=>{return ('en0_'+d.matchId);})
//            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'#ccc';})
            .style('text-anchor', 'middle').style('fill','white')
            .style('font-weight', 'normal').style(  'font-family','arial') //"helvetica neue")//'dominant-baseline','middle')
            .text('val').style('font-size','0.6vw')
            .on('mouseover',d=>{d3.select('#'+d).text(d)})
            .on('mouseout',d=>{d3.select('#'+d).text(valFormat(dashData[d][0].values[0].value)+' '+dashData[d][0].unit)});
        liste_T.append('circle').attr('cx',5).attr('cy',5).attr('id',d=>{return (d+'_c')})
            .attr('r',(4)).style('fill', 'yellow'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
}
//------
    function aff_histo (){
        d3.select("#histo").remove();
        console.log('histData',histData);
        affiche_curve(histData[0],"Histo",svg);
//        affiche_curve(dReg[getIndexdata('fullFR')].data.slice(),"fullFR",svgfrAll);
	path_item();
    }

//-----------------------------------------------------------
//-  CURVE / LINE CHART STANDARD
//-----
//
    function affiche_curve(dMult, selectValue, svgAff) {
//    console.log('dMult',dMult);
    //console.log(svgAff);
//    let w_g = svgAff._groups[0][0].attributes[1].nodeValue-margin.left-margin.right , //-margin.padding,
//        h_g = svgAff._groups[0][0].attributes[2].nodeValue-margin.top-margin.bottom
	let w_g = (width/2)-100, h_g = (height/2)-100,
        n_ticks = (w_g/15 | 0); //-h_header;//-margin.padding;
    //console.log(dMult[0].name,'x',w_g,'y',h_g);
	//	let w_g=width-margin.left-margin.right-margin.padding, h_g=height-margin.top-margin.bottom-h_header-margin.padding;
    // ontrace des courbes
    const x = d3.scaleLinear()
        .range([0, w_g]); //width-margin.left-margin.right-margin.padding]);
    const y = d3.scaleLinear()
        .range([h_g,0]);
//    const yR = d3.scaleLinear() //right scale
 //       .range([h_g,0]);
//    const yL = d3.scaleSymlog()
//        .range([h_g,0]);
    var line = d3.line()
        .x(function(d) { return x(d.timestamp); }) //vep
        .y(function(d) { return y(d.value);}) //(d3.select("#log_i")._groups[0][0].checked) ? yL(d.value) : y(d.value); }) //byEP
        .curve(d3.curveLinear);
/*    var lineR = d3.line()
        .x(function(d) { return x(d.timestamp); }) //vep
        .y(function(d) { return yR(d.value);}) //(d3.select("#log_i")._groups[0][0].checked) ? yL(d.value) : y(d.value); }) //byEP
        .curve(d3.curveCardinal);*/
	x.domain([
        d3.min(histData, function(c) {
        return d3.min(c.values, function(v) {
        return v.timestamp; });}),
        d3.max(histData, function(c) {
        return d3.max(c.values, function(v) {
        return v.timestamp; });})]);
	y.domain([
        d3.min(histData, function(c) {
        return d3.min(c.values, function(v) {
        return v.value; });})
        , d3.max(histData, function(c) {
      	return d3.max(c.values, function(v) { //console.log(v);
        return v.value; });})]);
/*	yL.domain([0, d3.max(dMult, function(c) {
      	return d3.max(c.values, function(v) {
        return v.value; });})]);

    yR.domain([0, d3.max(dMult, function(c) { //console.log(c);
        return c.scale==0?0:d3.max(c.values, function(v) {
        return v.value; });})]);
*/
//    let index=dHist.findIndex(d=>{return d.item==selectValue;}); //console.log('item',index,selectValue);
//    let indexReg=dReg.findIndex(d=>{return d.item==selectValue;}); //console.log('item',index,selectValue);
//console.log(line(histData[0].values));
	const g_line = svgAff
	    .append("g").attr('id','histo')
	    .attr("class","g_line")
    	.attr("transform", "translate(" + (45) + "," + (height/2) + ")");
//    g_line.append('rect').attr('width',w_g).attr('height',h_g).style('fill','#333').style('opacity',0.2);
    // Ajout de l'axe X
    g_line.append("g").raise()
        .attr("transform", "translate(0," + (h_g) + ")")
        .call(d3.axisBottom(x).ticks(n_ticks).tickFormat(d3.timeFormat("%d/ %H:%M")))
//        .call(d3.axisBottom(x).ticks(dHist[0].values.length-1).tickFormat(d3.timeFormat("%a %d/%m")))
        .selectAll("text")	
        	.style("text-anchor", "end")
        	.attr("dx", "-.8em")
        	.attr("dy", ".15em")
        	.attr("transform", "rotate(-65)");
    // Ajout de l'axe Y et du texte associé pour la légende
    g_line.append("g")
        .call(d3.axisLeft(y))
        .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .style("text-anchor", "end")
            .text(histData[0].unit);
    // Ajout de l'axe yR et du texte associé pour la légende
/*    g_line.append("g").attr('transform','translate('+(w_g)+',0)')
        .call(d3.axisRight(yR))
        .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .style("text-anchor", "end")
            .text("#");*/
    // on trace toutes les courbes
//    console.log(dMult.values[0],y(dMult.values[0].value),x(dMult.values[0].timestamp));
    var g_lines = g_line.selectAll(".selected").raise()
        .data(histData).enter().append("g")
        .attr("class", "selected");

let tempData = histData;
        tempData = tempData.map( o => { return o.values.filter( v=> { return v.value != null; }) });
// console.log(tempData[0]);
// console.log(histData[0].values);
    g_lines.append("path")
        .attr("class", "line")
        .attr("id",(d,i)=>{return "l"+i;})//.transition().duration(2000)
        .attr("d", (d)=>{ return line( tempData[0]); })       //histData[0].values);})
//        .attr("d", (d)=>{return d.scale==0?line(d.values):lineR(d.values);})
        .style("stroke", function(d,i) { return couleur[(i*5)%nbCouleur];}).style("stroke-width", "1px");
    // curseur
    var class_mpl = 'mpl'+selectValue, class_ml='ml'+selectValue;
	var mouseG = g_line.append("g").lower()
  		.attr("class", "mouse-over-effects");
	mouseG.append("path")
		.attr("class", class_ml)
		.style("stroke", "grey")
		.style("stroke-width", "1px").style("stroke-dasharray",2)
		.style("opacity", "1");
	var mousePerLine = mouseG.selectAll('.'+class_mpl)
		.data(histData).enter()
 		.append("g").attr("class", class_mpl);
    // reperage du point d'intersection curseur/courbe
	mousePerLine.append("circle")
		.attr("r", 3)
		.style("stroke", function (d,i) { return couleur[(i*5)%nbCouleur];})
		.style("fill", "none").style("stroke-width", "2px").style("opacity", "0");
	mousePerLine.append("text")
    	.attr("class", "hover-text").style('font-size','1.5vh').style("font-family","arial") //"HelveticaNeue-Light")
    	.attr("dy", "0.1em")
    	.attr("transform", "translate(10,3)");
	mouseG.append('rect') 
		.attr('width', w_g) .attr('height', h_g)
		.attr('fill', 'none')
		.attr('pointer-events', 'all')
		.on('mouseout', function () { // on mouse out hide line, circles and text
  			d3.select("."+class_ml).style("opacity", "0");
			d3.selectAll("."+class_mpl+" circle").style("opacity", "0");
			d3.selectAll("."+class_mpl+" text").style("opacity", "0");
			})
		.on('mouseover', function () { // on mouse in show line, circles and text
			d3.select("."+class_ml).style("opacity", "1");
			d3.selectAll("."+class_mpl+" circle").style("opacity", "1");
			d3.selectAll("."+class_mpl+" text").style("opacity", "1");
  			})
		.on('mousemove', function () { // mouse moving over canvas
			var mouse = d3.mouse(this);
				d3.selectAll("."+class_mpl)
      				.attr("transform", function (d, i) {
						var xDate = x.invert(mouse[0]),
							bisect = d3.bisector(function (d) { return d.timestamp; }).left;
							idx = bisect(d.values, xDate); //console.log(idx,d.values[idx].date);
                            try {
                            laDate = new Date(d.values[idx].timestamp); //.toLocaleDateString("fr-FR");
                            laDateText = laDate.getHours()+':'+laDate.getMinutes();
//                            console.log(laDate.getHours());
                            laDateX = x(d.values[idx].timestamp); //console.log('laDateX',laDateX);
                        //    d3.select("#laDate").attr("x",laDateX).text(laDate);
                        } catch{ console.log('erreur 1');}
                            try {
							  d3.select(this).select('text')
								.text(valFormat(y.invert(y(d.values[idx].value)).toFixed(1))+" ["+(laDateText)+"]"); //d.dataReference
							  d3.select("."+class_ml)
								.attr("d", function () {
									var data = "M" + x(d.values[idx].timestamp) + "," + h_g;
										data += " " + x(d.values[idx].timestamp) + "," + 0; //console.log(data);
									return data; });
							  return "translate(" + (x(histData[0].values[idx].timestamp)) + "," + ((y(histData[0].values[idx].value)) )+ ")";
                            } catch {console.log('erreur2');}
					});
  			});
    var legendM = g_lines.append("g")
        .attr("class","legend")
        .attr("transform",(d,i)=>{ return "translate(50,"+(30+i*16)+")";});
        legendM.append('circle')
            .attr('r',5).attr('cx',1).attr('cy',2).style('fill',(d,i)=>{return couleur[(i*5)%nbCouleur];})
            .on('mouseover',function(d,i){ d3.select(this).style('fill','blue').attr('r',7);})
            .on('mouseout',function(d,i){ d3.select(this).style('fill',couleur[(i*5)%nbCouleur]).attr('r',5);});
        legendM.append("text").style("font-size","1.7vh").attr('x',10).attr('y',6).style('text-anchor','start').style("font-family","arial")
            .text((d)=>{return d.dataReference;});

	}
//----------------------------------------------------------------
//
function clearSVG() {
    d3.select('#credentials').style('display','none');
    svg.selectAll('g').remove();
}
  </script>
</body>
</html>