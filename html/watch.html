<!DOCTYPE html>
<title>WATCH 2.0</title>
<meta name="description" content="Get data a,d keep an eyes on ...">
<meta name="author" content="e-Coucou">
<html class="rky">
<meta charset="utf-8">
<title>Pirénées 2.0</title>
<style>
@import url(../css/new.css);
.rky header {
    position: fixed;
    top:0px;
    left:0px;
    width:100%;
    height: 50px;
    z-index: 0;
    background: #1e3F5E; /*#FE6F5E;/*#b0c4de; /*add8e6; /*f0f8FF;*/
  color: #fff;
  font-family: "helvetica neue", sans-serif;
}

.rky header aside{
    left:20px;
    width:100%;
    height: 20px;
  font-size: 11px;
  float: left;
  margin-right: 0.8em;
  padding-top: .2em;
  color: #fff;
}
.rky aside {
  font-size: 1.5vh;
  font-family: "helvetica neue", sans-serif;
  font-weight: 150;
  text-anchor: end;
  margin-right: 0.9vh;
    float: right;
/*    box-shadow: inset 5px 0 5px -5px #29627e;*/
}
#svg {
	display: block;
	margin: auto;
	opacity: 1;
/*	position : relative;*/
}
.rky h1 {
  font-family: "helvetica neue", sans-serif;
  font-size: 5vh;
  letter-spacing: 0.2vh;
  margin-left: 0px;
  margin-bottom: 0px;
  font-weight: 50;
  text-rendering: optimizeLegibility;
}
#h1 {
  font-size: 28px;
  font-weight: 250;
  letter-spacing: 2px;
  margin-left: 150px;
  margin-top: 5px;
  position: absolute;
  text-rendering: optimizeLegibility;
}
.rky footer aside{
    left:20px;
    width:50%;
    height: 20px;
  font-size: 11px;
  float: left;
  margin-right: 0.8em;
  padding-top: .2em;
  color: #fff;
}
.rky footer {
  position: fixed;
  bottom: 0px;
    left:0px;
    width:100%;
    height: 20px;
  font-size: 11px;
  float: left;
  margin-right: 0.8em;
  padding-top: .5em;
    background: #1e3F5E; /*#FE6F5E;/*#b0c4de; /*add8e6; /*f0f8FF;*/
}
.rky footer aside:after {
  padding-left: .5em;
  content: "|";
}
.rky footer {
  margin-top: 0.1em;
}
#date {
	left: 100px;
	color: 'red';
}
input#username,
input#password,
input#connexion { 
    border: 1px dotted #ccc;
    background: white;
    font-family: monospace;
    padding: 2% 2%;
    font-size: 18px;
    margin: 2% 2% 2% 5%;
    width : 85%;
    height: 40%;
    color: red;
}
input:focus { 
    background-color:#0cf; color: red; outline: none;
}
#credentials {
  left: 30%;
  top: 100px;
  margin: 10px;
  padding: 10px;
  width: 40%;
  position: absolute;
  border: 3px solid #ff7788;
}
#date {
	right:100px;
	width: 30%;
}
</style>
<header>
  <div id='h1'>Watch 2.0</div>
  <aside >April, 2021<br><br> | v 0.11</aside>
  <div id='menu'></div>
</header>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://unpkg.com/d3@5.7.0/dist/d3.min.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.js" charset="utf-8"></script>
<body>
    <div id="chart"></div>
    <div id="credentials">
    <form name="saisie" onSubmit="return credClick()">
        <input type="text" id="username"><br>
        <input type="text" id="password">
<!--        <input name="Submit"  type="submit" id="connexion" value="Connexion" > -->
    </form></div>
  <footer>
  	<div>
      <aside>(c) e-Coucou | y2kL | Avril, 2021</aside>
      <aside id="date">time</aside>
    </div>
  </footer>
  <script type="text/javascript">
    var config = {credOK: false, tagOK:false, dataOK:false, arcOK:false, arbreOK: false};
    var urlBase = 'https://cors-rky.herokuapp.com/https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
	var urlBaseOld = 'https://oianalytics-100.optimistik.fr/api/optimistik/data/time_values?dataReferenceList=';
    var urlTime = '';
   	var interval = 'PT1M'  // PnYnMnD  TnHnMnS
    var urlRes = '&resolution='+interval;
    var url = '';
    let listeT1 = ['E-T15021','E-T15022','E-T15023','E-T15024','E-T15025','E-T15026','E-T15027','E-T15028','E-T15029','E-T15030','E-T15031','E-T15032']
    let listeT2 = ['E-T15041','E-T15042','E-T15043','E-T15044','E-T15045','E-T15046','E-T15047','E-T15048','E-T15049','E-T15050','E-T15051','E-T15052']
    let liste1 = ['E-T15099','E-TS19801','E-T19908','E-LX19901','E-TX19902','E-AO19991','E-F15154','E-PS15007','E-PS15011','E-PS15505','E-PS15605','E-AO19992','E-AO19993','E-AO19994'];
    let liste2 = ['E-PS15007','E-T15006','E-TC15002','E-TC15005','E-TY15004','E-T15401'];
    let liste3 = ['E-F15154','E-FC15167','E-P15104','E-P16151','E-PO16151','E-T15106','E-TC15103'];
	// Chart dimensions.
	var margin = {top: 20, right: 20, bottom: 30, left: 50},
    	width = window.innerWidth; // - margin.right-margin.left,
    	height = window.innerHeight; // - margin.top - margin.bottom;
	var couleur = ['grey','green','violet','cyan','blue','orange','yellow','red'];
	var dashData=[], username='Username', password='Password';
	// Create the SVG container and set the origin.
	const svg = d3.select('#chart').append("svg")
    	.attr("id", "svg")
    	.attr("width", (width))
    	.attr("height", (height));

	//credentials ...
	let code =btoa(username+':'+password);
	cred();
//---------------
// get Data
function getValeur() {
    let refDashboard='';
    let now = new Date(Date.now());
    let end = new Date(Date.now());
//    let offset = now.getTimezoneOffset();
//    let hour = now.getHours()+offset/60;
//	now.setHours(hour);
	now.setMinutes(now.getMinutes()-11);
	console.log('heure',now,end);
    urlTime = '&from='+encodeURIComponent(now.toISOString())+'&to='+encodeURIComponent(end.toISOString());
    console.log(urlTime);
    url = urlBase+encodeURIComponent('E-T15099')+urlTime+'&resolution=PT1H';
    getDashData(url,'coucou','#info');
//    getValeurListe(urlTime,listeT1);
//    getValeurListe(urlTime,listeT2);
//    getValeurListe(urlTime,liste1);
//    getValeurListe(urlTime,liste2);
    getValeurListe(urlTime,liste3);
}
function getValeurListe(urlTime,liste) {
	liste.forEach( tag => {
		url = urlBase+encodeURIComponent(tag)+urlTime+'&resolution=PT1H';
		getDashData(url,tag,'#'+tag);
	});
}
//----------------------------------------------------------------------------------------
//- lecture du dashboard ...
//----------------------------------------

function getDashData(urldata,index,id) {
    var opt = fetch(urldata, {method: 'GET',headers: new Headers({'Access-Control-Allow-Origin':'*','Accept':'application/json',
        'mode':'no-cors','credentials':'includes','Authorization':'basic '+code})}).then(response => {
        return response.json();
        })
    .then(data => { 
            dashData[index]=data;
            let value = data[0].values[0].value, unit = data[0].unit;
//            console.log(id,value);
            d3.selectAll(id).text(valFormat(value)+' '+data[0].unit);
            d3.selectAll(id+'_c').style('fill','#0f0');
            d3.selectAll(id+'_r').style('stroke','#00f');
            d3.selectAll('#date').text('| '+i_c(data[0].values[0].timestamp));
            update_level(id,value,unit,true);
//            dispatch.call('dashboard');
        })
    .catch(err => {
//        infoG.select('text').text("ERREUR : "+err);
//        infoG.select('circle').attr('fill','black');
//        config.dataOK=false;
		dashData[index]=[{values:[{timestamp:0,value:-1}],unit:' xxx'}];
        d3.selectAll(id).text(valFormat(-1)+' '+'xxx');
      console.log(err);
    })   
}
let valFormat = (a) => { 
        let r = (a>1000) ? Math.round(a) : ( (a>10)? Math.round(a*10.0)/10 : Math.round(a*100.0)/100);
        return String(r).replace(/(.)(?=(\d{3})+$)/g,'$1 ');
}
var format = d3.timeFormat("%H:%M:%S");
    function i_c(d) { 
    	return format( new Date(d));
    }
//----------------------------------------------------------------
// CREDENTIALS
//
function cred() {
    svg.attr("viewBox", "0 0 "+(width )+" "+(height))
    let connexion = svg.append('g').selectAll('g').data([0]).enter().append('g')
                        .attr('transform', (d,i)=> {return 'translate('+(0.25*width)+','+(0.6*height)+')';})
                        .on('click',get_connexion)
                        .on('mouseover',(d,i)=> {
                            d3.selectAll('#rect_connexion').style('fill','red')  })
                        .on('mouseout',(d)=> {
                            d3.selectAll('#rect_connexion').style('fill','#77C')  });

        connexion.append('rect').attr('rx',2).attr('ry',2).attr('id','rect_connexion')
            .attr('width',(0.5*width)).attr('height',(0.1*height)).style('fill', '#77C'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
        connexion.append('text').attr('x',(0.25*width)) //.attr('y',10)
            .attr('y',(0.07*height)).attr('id','connexion') //.attr('id',(d)=>{return ('en0_'+d.matchId);})
//            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'#ccc';})
            .style('text-anchor', 'middle').style('fill','white')
            .style('font-weight', 'bold').style('dominant-baseline','middle')
            .text('Connexion').style('font-size','4vw');
    var credential = [
                {name: 'username', type: 'text', display: 'Username'},
                {name: 'password', type: 'text', display: 'Password'},
                {name: 'submit', type: 'submit', display: 'Username'}
            ];
    let size={l:200,h:200};
/*    let credG = graph.append('g')
        .append('foreignObject').attr('x',10).attr('y',10).attr('width',300).attr('height',150);
    credG.append('rect').attr('x',width/2-size.l/2+margin.left).attr('y',80)
        .attr('width',size.l).attr('height',size.h).style('fill','#BCD4E6');
		*/
        d3.select('#credentials').attr('width',300).style('display','inline').raise();
        d3.select('#username').attr('placeholder',username).on('change',credClick);
        d3.select('#password').attr('placeholder',password).on('change',credClick);
}

function credClick() {
    let val = d3.select('#username').property('value');
    if (val!='') username=val;
    val = d3.select('#password').property('value');
    if (val!='') password=val;
    code =btoa(username+':'+password);
	if (username!='Username' && password != 'Password') {
		config.credOK=true;
	} else {
		console.log('saisie credential');
    }
//	d3.select('#connexion').style('background',"yellow");
//	console.log(code);
    return false;
}
function get_connexion() {
	console.log('Code sécurisé de connexion :',code);
	clearSVG();
	affiche_trame();
/*	aff_valeur();
	aff_liste_T(listeT1,0.01*width);
	aff_liste_T(listeT2,0.81*width);
	aff_liste_T(liste1,0.20*width);
	aff_liste_T(liste2,0.39*width);
*/	aff_liste_T(liste3,0.9*width);
	
	getValeur();
}
var shape = { cuveV : 'M 0,0 L 1,0 M 0,0 L 0,1 Q 3,-1 6,1 L 6,12 Q 3,14 0,12 Z', cuveH : 'M 0,0 L 1,0 M 0,0 L 0,1 M 5,0 L 35,0 Q 40,8 35,16 L 5,16 Q 0,8 5,0 Z' }
function affiche_trame() {
	const {h,l} = shape_cuve(500,500,7,'R19900',shape.cuveH,0)
	shape_level(500+l-5*7,500,7,h,15,'E-LX19901',50,false);
	shape_temp(450,330,5,3,8,'E-T19908',50,false);
	shape_temp(450,360,5,3,8,'E-TS19801',50,false);
	shape_temp(450,390,5,3,8,'E-TX19902',50,false);
	shape_temp(750,200,5,3,8,'E-AO19993',50,false);
	shape_temp(750,230,5,3,8,'E-AO19994',50,false);
	shape_temp(750,260,5,3,8,'E-AO19991',50,false);
	shape_temp(750,290,5,3,8,'E-AO19992',50,false);
	// rechauffeur Electrique
	let Ex1 = {x:43, y:80, e: 10};
	with (Ex1) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E15400',shape.cuveV,0); y += 5; x += 3;// console.log('size : ',h,l)
		y = shape_temp(x,y,e,0,0,'E-T15408',50,false);
		y = shape_temp(x,y,e,0,0,'E-J15406',50,false);
		y = shape_temp(x,y,e,3,e,'E-TS15409',50,false);
		y = shape_temp(x,y,e,3,e,'E-TDX15407',50,false);
	}
	// réacteur K15000
	let Ex2 = {x:150, y:80, e: 20};
	with (Ex2) {
		let i =0;
		const {h,l} = shape_cuve(150,80,20,'K15000',shape.cuveV,0); y += 5; x += 3;
		y = shape_temp(x,y,e,e/3,e/2,'E-T15021',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-T15008',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-TC15019',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-TY15012',50,false);
	}
	// GV 40
	let Ex3 = {x:350, y:80, e: 15};
	with (Ex3) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E15500',shape.cuveV,0); y += 5, x += 3;
		shape_level(x+l-15,y,e,h-e*2,10,'E-LC15504',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-PC15506',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-LS15503',50,false);
	}
	// GV 10
	let Ex4 = {x:350, y:280, e: 12};
	with (Ex4) {
		let i =0;
		const {h,l} = shape_cuve(x,y,e,'E15600',shape.cuveV,0); y += 5, x += 3;
		shape_level(x+l-15,y,e,h-e*2,10,'E-LC15604',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-PC15606',50,false);
		y = shape_temp(x,y,e,e/3,e/2,'E-LS15603',50,false);
	}

}
function refresh() {
	d3.selectAll('circle').style('fill','black');
	d3.selectAll('rect').style('stroke','black');
	getValeur();
}
//-----------------------
//
function shape_cuve (x,y,ech,id,forme,rot) {
	let shape= svg.append('g').selectAll('g').data([0]).enter().append('g')
					.attr('transform','translate('+x+','+(y)+') scale('+ech+')'); // rotate('+rot+')');
		shape.append('path').attr('d', forme).style('stroke-width',1/ech).style('stroke','#666').style('fill','#EEE').attr('id',id+'_p');
	let rect = document.getElementById(id+'_p').getBoundingClientRect();
	let h = rect.height;
	let l = rect.width;
 	return {h: h, l: l};
}
function shape_level (x,y,ech,h,l,id,val,status) {
	liste3.push(id);// ech = 5;// h= ech *10; l=2*ech;
	let level = svg.append('g').selectAll('g').data([0]).enter().append('g')
					.attr('transform','translate('+x+','+y+')').raise(); // scale('+ech+')').raise();
		level.append('rect').attr('width',l).attr('height',h).attr('x',1).attr('y',1).style('stroke-width',1)
			 .style('stroke','#666').style('fill','#fff').attr('id',id+'_s');
		level.append('rect').attr('width',(l-2)).attr('x',2).attr('y',(h*(100-val)/100)+1).attr('height',(h*val/100)).raise()
			.attr('id',id+'_val')
			.style('stroke-width',1).style('stroke','#666').style('fill',status?'#00b':'#ccc');
		level.append('text').text(val).attr('id',id+'_txt').raise()
			.attr('x',(0.7*l)).attr('y',(0.5*h))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.5*5)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");
		return;
}
function shape_temp (x,y,ech,h,l,id,val,status) {
	liste3.push(id); ech = 5; h= ech *3.7; l=9*ech;
	let temp = svg.append('g').selectAll('g').data([0]).enter().append('g')
					.attr('transform','translate('+x+','+y+')').raise(); // scale('+ech+')').raise();
		temp.append('rect').attr('width',l).attr('height',h).attr('x',1).attr('y',1).style('stroke-width',1).style('stroke','#666').style('fill','#fff').style('rx',1).style('ry',1).attr('id',id+'_r');
		temp.append('text').text(val).attr('id',id+'_txt')
			.attr('x',(0.52*l)).attr('y',(0.8*h))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.5*ech)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue");
		temp.append('text').text(val) // no id
			.attr('x',(0.52*l)).attr('y',(0.4*h))
            .style('text-anchor', 'middle').style('fill','black').style('font-size',1.5*ech)
            .style('font-weight', 'normal').style('dominant-baseline','middle').style(  'font-family',"helvetica neue")
            .text(id);
//        temp.append('circle').attr('r',1).attr('cx',1).attr('cy',1).style('fill','red').attr('id',id+'_c');
		return (y+h*1.1);
}
function update_level(id,val,unit,status){ //console.log('rect_s',id);
	try {
		let h = d3.select(id+'_s').node().getBoundingClientRect().height; 
		d3.selectAll(id+'_val').attr('y',(h*(100-val)/100)+1).attr('height',(h*val/100)).style('fill',status?'#0e0':'black');
	} catch (error) {
	  // not level
	}
	d3.selectAll(id+'_txt').text(valFormat(val)+' '+unit);
}
function aff_valeur() {
	//on affiche
//	console.log(width,height);
	let h_g= height-50-20;
    let liste = svg.append('g').selectAll('g').data(['E-T15099','futur']).enter().append('g')
                        .attr('transform', (d,i)=> {return 'translate('+(0.20*width)+','+(0.01*h_g+50 +i*h_g/2)+')';})
                        .on('click',refresh)
                        .on('mouseover',(d,i)=> {
                            d3.selectAll('#rect_refresh'+i).style('fill','red');
                            console.log(d,i);  })
                        .on('mouseout',(d,i)=> {
                            d3.selectAll('#rect_refresh'+i).style('fill','#337')  });

        liste.append('rect').style('rx',5).style('ry',5).attr('id',(d,i)=>{return 'rect_refresh'+i; })
            .attr('width',(width*0.6)).attr('height',(0.47*h_g)).style('fill', '#337'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
        liste.append('text').attr('x',(0.3*width)) //.attr('y',10)
            .attr('y',(0.27*h_g)).attr('id','info') //.attr('id',(d)=>{return ('en0_'+d.matchId);})
//            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'#ccc';})
            .style('text-anchor', 'middle').style('fill','white')
            .style('font-weight', 'bold').style('dominant-baseline','middle')
            .text('val').style('font-size','13vw')
            .on('mouseover',d=>{d3.select('#info').text(d)})
            .on('mouseout',d=>{d3.select('#info').text(valFormat(dashData['coucou'][0].values[0].value)+' '+dashData['coucou'][0].unit)});
}
//--------------
// on affiche les listes de valeur sur le coté ...
function aff_liste_T(liste,decalage) {
	let h_g= height-50-20;
	let inc = 0.96*h_g/liste.length;
	let w = 0.10;
    let liste_T = svg.append('g').selectAll('g').data(liste).enter().append('g')
                        .attr('transform', (d,i)=> {return 'translate('+(decalage)+','+(0.02*h_g+50 +i*inc)+')';})
                        .on('click',refresh)
                        .on('mouseover',(d,i)=> {
                            d3.selectAll('#rect_refresh'+d).style('fill','red');
                            d3.selectAll('#'+d+'_r').style('fill','red');  })
                        .on('mouseout',(d,i)=> {
                            d3.selectAll('#rect_refresh'+d).style('fill','#1e3F5E');
                            d3.selectAll('#'+d+'_r').style('fill','white');  });

        liste_T.append('rect').attr('rx',1).attr('ry',1).attr('id',(d,i) => { return 'rect_refresh'+d; })
            .attr('width',(w*width)).attr('height',(inc-2)).style('fill', '#1e3F5E'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
        liste_T.append('text').attr('x',(w/2*width)) //.attr('y',10)
            .attr('y',(inc/2+2)).attr('id',d=>{return d}) //.attr('id',(d)=>{return ('en0_'+d.matchId);})
//            .style('fill', (d,i,a) => { return a[i].__data__>a[(i+1)%2].__data__?'#fff':'#ccc';})
            .style('text-anchor', 'middle').style('fill','white')
            .style('font-weight', 'bold').style(  'font-family',"helvetica neue")//'dominant-baseline','middle')
            .text('val').style('font-size','1.3vw')
            .on('mouseover',d=>{d3.select('#'+d).text(d)})
            .on('mouseout',d=>{d3.select('#'+d).text(valFormat(dashData[d][0].values[0].value)+' '+dashData[d][0].unit)});
        liste_T.append('circle').attr('cx',5).attr('cy',5).attr('id',d=>{return (d+'_c')})
            .attr('r',(4)).style('fill', 'yellow'); //(d,i)=>{return (i%2===0)?'#BBB':'#DDD' ;}); //'#0a88ff');
}
//----------------------------------------------------------------
//
function clearSVG() {
    d3.select('#credentials').style('display','none');
    svg.selectAll('g').remove();
}
  </script>
</body>
</html>